<!DOCTYPE html><html lang="en" dir="ltr" data-theme="dark" data-has-toc data-has-sidebar class="astro-aiylphlt"> <head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Dspy Ruby | Systematic</title><link rel="canonical" href="https://fro.bot/systematic/reference/skills/dspy-ruby/"/><link rel="sitemap" href="/systematic/sitemap-index.xml"/><link rel="shortcut icon" href="/systematic/favicon.svg" type="image/svg+xml"/><meta name="generator" content="Astro v5.17.1"/><meta name="generator" content="Starlight v0.37.6"/><meta property="og:title" content="Dspy Ruby"/><meta property="og:type" content="article"/><meta property="og:url" content="https://fro.bot/systematic/reference/skills/dspy-ruby/"/><meta property="og:locale" content="en"/><meta property="og:description" content="Build type-safe LLM applications with DSPy.rb — Ruby's programmatic prompt framework with signatures, modules, agents, and optimization. Use when implementing predictable AI features, creating LLM signatures and modules, configuring language model providers, building agent systems with tools, optimizing prompts, or testing LLM-powered functionality in Ruby applications."/><meta property="og:site_name" content="Systematic"/><meta name="twitter:card" content="summary_large_image"/><meta name="description" content="Build type-safe LLM applications with DSPy.rb — Ruby's programmatic prompt framework with signatures, modules, agents, and optimization. Use when implementing predictable AI features, creating LLM signatures and modules, configuring language model providers, building agent systems with tools, optimizing prompts, or testing LLM-powered functionality in Ruby applications."/><script>
	window.StarlightThemeProvider = (() => {
		const storedTheme =
			typeof localStorage !== 'undefined' && localStorage.getItem('starlight-theme');
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
		document.documentElement.dataset.theme = theme === 'light' ? 'light' : 'dark';
		return {
			updatePickers(theme = storedTheme || 'auto') {
				document.querySelectorAll('starlight-theme-select').forEach((picker) => {
					const select = picker.querySelector('select');
					if (select) select.value = theme;
					/** @type {HTMLTemplateElement | null} */
					const tmpl = document.querySelector(`#theme-icons`);
					const newIcon = tmpl && tmpl.content.querySelector('.' + theme);
					if (newIcon) {
						const oldIcon = picker.querySelector('svg.label-icon');
						if (oldIcon) {
							oldIcon.replaceChildren(...newIcon.cloneNode(true).childNodes);
						}
					}
				});
			},
		};
	})();
</script><template id="theme-icons"><svg aria-hidden="true" class="light astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M5 12a1 1 0 0 0-1-1H3a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1Zm.64 5-.71.71a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l.71-.71A1 1 0 0 0 5.64 17ZM12 5a1 1 0 0 0 1-1V3a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm5.66 2.34a1 1 0 0 0 .7-.29l.71-.71a1 1 0 1 0-1.41-1.41l-.66.71a1 1 0 0 0 0 1.41 1 1 0 0 0 .66.29Zm-12-.29a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.71-.71a1.004 1.004 0 1 0-1.43 1.41l.73.71ZM21 11h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2Zm-2.64 6A1 1 0 0 0 17 18.36l.71.71a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.76-.66ZM12 6.5a5.5 5.5 0 1 0 5.5 5.5A5.51 5.51 0 0 0 12 6.5Zm0 9a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0 3.5a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg><svg aria-hidden="true" class="dark astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.64 13a1 1 0 0 0-1.05-.14 8.049 8.049 0 0 1-3.37.73 8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.69 1 1 0 0 0-.36-1.05Zm-9.5 6.69A8.14 8.14 0 0 1 7.08 5.22v.27a10.15 10.15 0 0 0 10.14 10.14 9.784 9.784 0 0 0 2.1-.22 8.11 8.11 0 0 1-7.18 4.32v-.04Z"/></svg><svg aria-hidden="true" class="auto astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg></template><link rel="stylesheet" href="/systematic/_astro/print.DNXP8c50.css" media="print"><link rel="stylesheet" href="/systematic/_astro/index.BXAwLWpG.css">
<style>@layer starlight.components{:root{--sl-badge-default-border: var(--sl-color-accent);--sl-badge-default-bg: var(--sl-color-accent-low);--sl-badge-default-text: #fff;--sl-badge-note-border: var(--sl-color-blue);--sl-badge-note-bg: var(--sl-color-blue-low);--sl-badge-note-text: #fff;--sl-badge-danger-border: var(--sl-color-red);--sl-badge-danger-bg: var(--sl-color-red-low);--sl-badge-danger-text: #fff;--sl-badge-success-border: var(--sl-color-green);--sl-badge-success-bg: var(--sl-color-green-low);--sl-badge-success-text: #fff;--sl-badge-caution-border: var(--sl-color-orange);--sl-badge-caution-bg: var(--sl-color-orange-low);--sl-badge-caution-text: #fff;--sl-badge-tip-border: var(--sl-color-purple);--sl-badge-tip-bg: var(--sl-color-purple-low);--sl-badge-tip-text: #fff}[data-theme=light]:root{--sl-badge-default-bg: var(--sl-color-accent-high);--sl-badge-note-bg: var(--sl-color-blue-high);--sl-badge-danger-bg: var(--sl-color-red-high);--sl-badge-success-bg: var(--sl-color-green-high);--sl-badge-caution-bg: var(--sl-color-orange-high);--sl-badge-tip-bg: var(--sl-color-purple-high)}.sl-badge:where(.astro-r6rcksuz){display:inline-block;border:1px solid var(--sl-color-border-badge);border-radius:.25rem;font-family:var(--sl-font-system-mono);line-height:normal;color:var(--sl-color-text-badge);background-color:var(--sl-color-bg-badge);overflow-wrap:anywhere}.sidebar-content .sl-badge:where(.astro-r6rcksuz){line-height:1;font-size:var(--sl-text-xs);padding:.125rem .375rem}.sidebar-content a[aria-current=page]>.sl-badge:where(.astro-r6rcksuz){--sl-color-bg-badge: transparent;--sl-color-border-badge: currentColor;color:inherit}.default:where(.astro-r6rcksuz){--sl-color-bg-badge: var(--sl-badge-default-bg);--sl-color-border-badge: var(--sl-badge-default-border);--sl-color-text-badge: var(--sl-badge-default-text)}.note:where(.astro-r6rcksuz){--sl-color-bg-badge: var(--sl-badge-note-bg);--sl-color-border-badge: var(--sl-badge-note-border);--sl-color-text-badge: var(--sl-badge-note-text)}.danger:where(.astro-r6rcksuz){--sl-color-bg-badge: var(--sl-badge-danger-bg);--sl-color-border-badge: var(--sl-badge-danger-border);--sl-color-text-badge: var(--sl-badge-danger-text)}.success:where(.astro-r6rcksuz){--sl-color-bg-badge: var(--sl-badge-success-bg);--sl-color-border-badge: var(--sl-badge-success-border);--sl-color-text-badge: var(--sl-badge-success-text)}.tip:where(.astro-r6rcksuz){--sl-color-bg-badge: var(--sl-badge-tip-bg);--sl-color-border-badge: var(--sl-badge-tip-border);--sl-color-text-badge: var(--sl-badge-tip-text)}.caution:where(.astro-r6rcksuz){--sl-color-bg-badge: var(--sl-badge-caution-bg);--sl-color-border-badge: var(--sl-badge-caution-border);--sl-color-text-badge: var(--sl-badge-caution-text)}.small:where(.astro-r6rcksuz){font-size:var(--sl-text-xs);padding:.125rem .25rem}.medium:where(.astro-r6rcksuz){font-size:var(--sl-text-sm);padding:.175rem .35rem}.large:where(.astro-r6rcksuz){font-size:var(--sl-text-base);padding:.225rem .45rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) .sl-badge:where(.astro-r6rcksuz){vertical-align:middle}}
@layer starlight.components{.card:where(.astro-3nstnhqj){--sl-card-border: var(--sl-color-purple);--sl-card-bg: var(--sl-color-purple-low);border:1px solid var(--sl-color-gray-5);background-color:var(--sl-color-black);padding:clamp(1rem,calc(.125rem + 3vw),2.5rem);flex-direction:column;gap:clamp(.5rem,calc(.125rem + 1vw),1rem)}.card:where(.astro-3nstnhqj):nth-child(4n+1){--sl-card-border: var(--sl-color-orange);--sl-card-bg: var(--sl-color-orange-low)}.card:where(.astro-3nstnhqj):nth-child(4n+3){--sl-card-border: var(--sl-color-green);--sl-card-bg: var(--sl-color-green-low)}.card:where(.astro-3nstnhqj):nth-child(4n+4){--sl-card-border: var(--sl-color-red);--sl-card-bg: var(--sl-color-red-low)}.card:where(.astro-3nstnhqj):nth-child(4n+5){--sl-card-border: var(--sl-color-blue);--sl-card-bg: var(--sl-color-blue-low)}.title:where(.astro-3nstnhqj){font-weight:600;font-size:var(--sl-text-h4);color:var(--sl-color-white);line-height:var(--sl-line-height-headings);gap:1rem;align-items:center}.card:where(.astro-3nstnhqj) .icon:where(.astro-3nstnhqj){border:1px solid var(--sl-card-border);background-color:var(--sl-card-bg);padding:.2em;border-radius:.25rem;flex-shrink:0}.card:where(.astro-3nstnhqj) .body:where(.astro-3nstnhqj){margin:0;font-size:clamp(var(--sl-text-sm),calc(.5rem + 1vw),var(--sl-text-body))}}
@layer starlight.components{.card-grid:where(.astro-egg2xge6){display:grid;grid-template-columns:100%;gap:1rem}.card-grid:where(.astro-egg2xge6)>*{margin-top:0!important}@media(min-width:50rem){.card-grid:where(.astro-egg2xge6){grid-template-columns:1fr 1fr;gap:1.5rem}.stagger:where(.astro-egg2xge6){--stagger-height: 5rem;padding-bottom:var(--stagger-height)}.stagger:where(.astro-egg2xge6)>*:nth-child(2n){transform:translateY(var(--stagger-height))}}}
@layer starlight.components{svg:where(.astro-alwspyvt){color:var(--sl-icon-color);font-size:var(--sl-icon-size, 1em);width:1em;height:1em}}
@layer starlight.components{.sl-link-card:where(.astro-rxgzyju6){display:grid;grid-template-columns:1fr auto;gap:.5rem;border:1px solid var(--sl-color-gray-5);border-radius:.5rem;padding:1rem;box-shadow:var(--sl-shadow-sm);position:relative}a:where(.astro-rxgzyju6){text-decoration:none;line-height:var(--sl-line-height-headings)}a:where(.astro-rxgzyju6):before{content:"";position:absolute;inset:0}.stack:where(.astro-rxgzyju6){flex-direction:column;gap:.5rem}.title:where(.astro-rxgzyju6){color:var(--sl-color-white);font-weight:600;font-size:var(--sl-text-lg)}.description:where(.astro-rxgzyju6){color:var(--sl-color-gray-3);line-height:1.5}.icon:where(.astro-rxgzyju6){color:var(--sl-color-gray-3)}.sl-link-card:where(.astro-rxgzyju6):hover{background:var(--sl-color-gray-7, var(--sl-color-gray-6));border-color:var(--sl-color-gray-2)}.sl-link-card:where(.astro-rxgzyju6):hover .icon:where(.astro-rxgzyju6){color:var(--sl-color-white)}}
@layer starlight.components{.sl-steps{--bullet-size: calc(var(--sl-line-height) * 1rem);--bullet-margin: .375rem;list-style:none;counter-reset:steps-counter var(--sl-steps-start, 0);padding-inline-start:0}.sl-steps>li{counter-increment:steps-counter;position:relative;padding-inline-start:calc(var(--bullet-size) + 1rem);padding-bottom:1px;min-height:calc(var(--bullet-size) + var(--bullet-margin))}.sl-steps>li+li{margin-top:0}.sl-steps>li:before{content:counter(steps-counter);position:absolute;top:0;inset-inline-start:0;width:var(--bullet-size);height:var(--bullet-size);line-height:var(--bullet-size);font-size:var(--sl-text-xs);font-weight:600;text-align:center;color:var(--sl-color-white);background-color:var(--sl-color-gray-6);border-radius:99rem;box-shadow:inset 0 0 0 1px var(--sl-color-gray-5)}.sl-steps>li:after{--guide-width: 1px;content:"";position:absolute;top:calc(var(--bullet-size) + var(--bullet-margin));bottom:var(--bullet-margin);inset-inline-start:calc((var(--bullet-size) - var(--guide-width)) / 2);width:var(--guide-width);background-color:var(--sl-color-hairline-light)}}@layer starlight.content{.sl-steps>li>:first-child{--lh: calc(1em * var(--sl-line-height));--shift-y: calc(.5 * (var(--bullet-size) - var(--lh)));transform:translateY(var(--shift-y));margin-bottom:var(--shift-y)}.sl-steps>li>:first-child:where(h1,h2,h3,h4,h5,h6){--lh: calc(1em * var(--sl-line-height-headings))}@supports (--prop: 1lh){.sl-steps>li>:first-child{--lh: 1lh}}}
@layer starlight.components{.sl-link-button:where(.astro-dsyae72l){align-items:center;border:1px solid transparent;border-radius:999rem;display:inline-flex;font-size:var(--sl-text-sm);gap:.5em;line-height:1.1875;outline-offset:.25rem;padding:.4375rem 1.125rem;text-decoration:none}.sl-link-button:where(.astro-dsyae72l).primary{background:var(--sl-color-text-accent);border-color:var(--sl-color-text-accent);color:var(--sl-color-black)}.sl-link-button:where(.astro-dsyae72l).primary:hover{color:var(--sl-color-black)}.sl-link-button:where(.astro-dsyae72l).secondary{border-color:inherit;color:var(--sl-color-white)}.sl-link-button:where(.astro-dsyae72l).minimal{color:var(--sl-color-white);padding-inline:0}.sl-link-button:where(.astro-dsyae72l) svg{flex-shrink:0}@media(min-width:50rem){.sl-link-button:where(.astro-dsyae72l){font-size:var(--sl-text-base);padding:.9375rem 1.25rem}}.sl-markdown-content .sl-link-button:where(.astro-dsyae72l){margin-inline-end:1rem}.sl-markdown-content .sl-link-button:where(.astro-dsyae72l):not(:where(p *)){margin-block:1rem}}
</style><script type="module" src="/systematic/_astro/page.B1D-nYk3.js"></script></head> <body class="astro-aiylphlt"> <a href="#_top" class="astro-tdghjyio">Skip to content</a>  <div class="page sl-flex astro-r6lv7f2i"> <header class="header astro-r6lv7f2i"><div class="header astro-h2pe5waf"> <div class="title-wrapper sl-flex astro-h2pe5waf"> <a href="/systematic/" class="site-title sl-flex astro-hvbo5tpp">  <span class="astro-hvbo5tpp" translate="no"> Systematic </span> </a>  </div> <div class="sl-flex print:hidden astro-h2pe5waf"> <site-search class="astro-h2pe5waf astro-yuytr44a" data-translations="{&#34;placeholder&#34;:&#34;Search&#34;}"> <button data-open-modal disabled aria-label="Search" aria-keyshortcuts="Control+K" class="astro-yuytr44a"> <svg aria-hidden="true" class="astro-yuytr44a astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z"/></svg> <span class="sl-hidden md:sl-block astro-yuytr44a" aria-hidden="true">Search</span> <kbd class="sl-hidden md:sl-flex astro-yuytr44a" style="display: none;"> <kbd class="astro-yuytr44a">Ctrl</kbd><kbd class="astro-yuytr44a">K</kbd> </kbd> </button> <dialog style="padding:0" aria-label="Search" class="astro-yuytr44a"> <div class="dialog-frame sl-flex astro-yuytr44a">  <button data-close-modal class="sl-flex md:sl-hidden astro-yuytr44a"> Cancel </button> <div class="search-container astro-yuytr44a"> <div id="starlight__search" class="astro-yuytr44a"></div> </div> </div> </dialog> </site-search>  <script>
	(() => {
		const openBtn = document.querySelector('button[data-open-modal]');
		const shortcut = openBtn?.querySelector('kbd');
		if (!openBtn || !(shortcut instanceof HTMLElement)) return;
		const platformKey = shortcut.querySelector('kbd');
		if (platformKey && /(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)) {
			platformKey.textContent = '⌘';
			openBtn.setAttribute('aria-keyshortcuts', 'Meta+K');
		}
		shortcut.style.display = '';
	})();
</script> <script type="module" src="/systematic/_astro/Search.astro_astro_type_script_index_0_lang.BjGSYz_B.js"></script>   </div> <div class="sl-hidden md:sl-flex print:hidden right-group astro-h2pe5waf"> <div class="sl-flex social-icons astro-h2pe5waf"> <a href="https://github.com/marcusrbrown/systematic" rel="me" class="sl-flex astro-slnfz65f"><span class="sr-only astro-slnfz65f">GitHub</span><svg aria-hidden="true" class="astro-slnfz65f astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg></a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-afb54k27"> <span class="sr-only astro-afb54k27">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-afb54k27 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select autocomplete="off" class="astro-afb54k27"> <option value="dark" class="astro-afb54k27">Dark</option><option value="light" class="astro-afb54k27">Light</option><option value="auto" selected class="astro-afb54k27">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-afb54k27 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg> </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script> <script type="module">const r="starlight-theme",o=e=>e==="auto"||e==="dark"||e==="light"?e:"auto",c=()=>o(typeof localStorage<"u"&&localStorage.getItem(r));function n(e){typeof localStorage<"u"&&localStorage.setItem(r,e==="light"||e==="dark"?e:"")}const l=()=>matchMedia("(prefers-color-scheme: light)").matches?"light":"dark";function t(e){StarlightThemeProvider.updatePickers(e),document.documentElement.dataset.theme=e==="auto"?l():e,n(e)}matchMedia("(prefers-color-scheme: light)").addEventListener("change",()=>{c()==="auto"&&t("auto")});class s extends HTMLElement{constructor(){super(),t(c()),this.querySelector("select")?.addEventListener("change",a=>{a.currentTarget instanceof HTMLSelectElement&&t(o(a.currentTarget.value))})}}customElements.define("starlight-theme-select",s);</script> <script type="module">class s extends HTMLElement{constructor(){super();const e=this.querySelector("select");e&&(e.addEventListener("change",t=>{t.currentTarget instanceof HTMLSelectElement&&(window.location.pathname=t.currentTarget.value)}),window.addEventListener("pageshow",t=>{if(!t.persisted)return;const n=e.querySelector("option[selected]")?.index;n!==e.selectedIndex&&(e.selectedIndex=n??0)}))}}customElements.define("starlight-lang-select",s);</script> </div> </div> </header> <nav class="sidebar print:hidden astro-r6lv7f2i" aria-label="Main"> <starlight-menu-button class="print:hidden astro-qa7beyh5"> <button aria-expanded="false" aria-label="Menu" aria-controls="starlight__sidebar" class="sl-flex md:sl-hidden astro-qa7beyh5"> <svg aria-hidden="true" class="open-menu astro-qa7beyh5 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"/></svg> <svg aria-hidden="true" class="close-menu astro-qa7beyh5 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="m13.41 12 6.3-6.29a1.004 1.004 0 1 0-1.42-1.42L12 10.59l-6.29-6.3a1.004 1.004 0 0 0-1.42 1.42l6.3 6.29-6.3 6.29a1 1 0 0 0 0 1.42.998.998 0 0 0 1.42 0l6.29-6.3 6.29 6.3a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.42L13.41 12Z"/></svg> </button> </starlight-menu-button> <script type="module">class s extends HTMLElement{constructor(){super(),this.btn=this.querySelector("button"),this.btn.addEventListener("click",()=>this.toggleExpanded());const t=this.closest("nav");t&&t.addEventListener("keyup",e=>this.closeOnEscape(e))}setExpanded(t){this.setAttribute("aria-expanded",String(t)),document.body.toggleAttribute("data-mobile-menu-expanded",t)}toggleExpanded(){this.setExpanded(this.getAttribute("aria-expanded")!=="true")}closeOnEscape(t){t.code==="Escape"&&(this.setExpanded(!1),this.btn.focus())}}customElements.define("starlight-menu-button",s);</script>   <div id="starlight__sidebar" class="sidebar-pane astro-r6lv7f2i"> <div class="sidebar-content sl-flex astro-r6lv7f2i"> <sl-sidebar-state-persist data-hash="0gqyoby" class="astro-jppm6ggu"> <script aria-hidden="true">
		(() => {
			try {
				if (!matchMedia('(min-width: 50em)').matches) return;
				/** @type {HTMLElement | null} */
				const target = document.querySelector('sl-sidebar-state-persist');
				const state = JSON.parse(sessionStorage.getItem('sl-sidebar-state') || '0');
				if (!target || !state || target.dataset.hash !== state.hash) return;
				window._starlightScrollRestore = state.scroll;
				customElements.define(
					'sl-sidebar-restore',
					class SidebarRestore extends HTMLElement {
						connectedCallback() {
							try {
								const idx = parseInt(this.dataset.index || '');
								const details = this.closest('details');
								if (details && typeof state.open[idx] === 'boolean') details.open = state.open[idx];
							} catch {}
						}
					}
				);
			} catch {}
		})();
	</script>  <ul class="top-level astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <details open class="astro-2v7xa3ze"> <summary class="astro-2v7xa3ze"> <span class="group-label astro-2v7xa3ze"> <span class="large astro-2v7xa3ze">Getting Started</span>  </span> <svg aria-hidden="true" class="caret astro-2v7xa3ze astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="0"></sl-sidebar-restore> <ul class="astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <a href="/systematic/getting-started/installation/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Installation</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/getting-started/configuration/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Configuration</span>  </a> </li> </ul>  </details> </li><li class="astro-2v7xa3ze"> <details open class="astro-2v7xa3ze"> <summary class="astro-2v7xa3ze"> <span class="group-label astro-2v7xa3ze"> <span class="large astro-2v7xa3ze">Guides</span>  </span> <svg aria-hidden="true" class="caret astro-2v7xa3ze astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="1"></sl-sidebar-restore> <ul class="astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <a href="/systematic/guides/architecture/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Architecture</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/guides/conversion-guide/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Conversion Guide</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/guides/creating-skills/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Creating Custom Skills</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/guides/ocx-registry/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">OCX Registry Guide</span>  </a> </li> </ul>  </details> </li><li class="astro-2v7xa3ze"> <details open class="astro-2v7xa3ze"> <summary class="astro-2v7xa3ze"> <span class="group-label astro-2v7xa3ze"> <span class="large astro-2v7xa3ze">Reference</span>  </span> <svg aria-hidden="true" class="caret astro-2v7xa3ze astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="2"></sl-sidebar-restore> <ul class="astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <details open class="astro-2v7xa3ze"> <summary class="astro-2v7xa3ze"> <span class="group-label astro-2v7xa3ze"> <span class="large astro-2v7xa3ze">Skills</span>  </span> <svg aria-hidden="true" class="caret astro-2v7xa3ze astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="3"></sl-sidebar-restore> <ul class="astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Skills Reference</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/agent-browser/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Agent Browser</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/agent-native-architecture/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Agent Native Architecture</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/andrew-kane-gem-writer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Andrew Kane Gem Writer</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/brainstorming/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Brainstorming</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/compound-docs/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Compound Docs</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/create-agent-skills/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Create Agent Skills</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/dhh-rails-style/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">DHH Rails Style</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/document-review/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Document Review</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/dspy-ruby/" aria-current="page" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Dspy Ruby</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/every-style-editor/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Every Style Editor</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/file-todos/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">File Todos</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/frontend-design/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Frontend Design</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/gemini-imagegen/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Gemini Imagegen</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/git-worktree/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Git Worktree</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/orchestrating-swarms/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Orchestrating Swarms</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/rclone/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Rclone</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/resolve-pr-parallel/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Resolve_pr_parallel</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/setup/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Setup</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/skill-creator/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Skill Creator</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/skills/using-systematic/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Using Systematic</span>  </a> </li> </ul>  </details> </li><li class="astro-2v7xa3ze"> <details open class="astro-2v7xa3ze"> <summary class="astro-2v7xa3ze"> <span class="group-label astro-2v7xa3ze"> <span class="large astro-2v7xa3ze">Agents</span>  </span> <svg aria-hidden="true" class="caret astro-2v7xa3ze astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="4"></sl-sidebar-restore> <ul class="astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Agents Reference</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/agent-native-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Agent Native Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/ankane-readme-writer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Ankane Readme Writer</span> <span class="sl-badge default small  astro-2v7xa3ze astro-r6rcksuz">Docs</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/architecture-strategist/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Architecture Strategist</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/best-practices-researcher/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Best Practices Researcher</span> <span class="sl-badge success small  astro-2v7xa3ze astro-r6rcksuz">Research</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/bug-reproduction-validator/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Bug Reproduction Validator</span> <span class="sl-badge caution small  astro-2v7xa3ze astro-r6rcksuz">Workflow</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/code-simplicity-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Code Simplicity Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/data-integrity-guardian/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Data Integrity Guardian</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/data-migration-expert/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Data Migration Expert</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/deployment-verification-agent/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Deployment Verification Agent</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/design-implementation-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Design Implementation Reviewer</span> <span class="sl-badge tip small  astro-2v7xa3ze astro-r6rcksuz">Design</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/design-iterator/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Design Iterator</span> <span class="sl-badge tip small  astro-2v7xa3ze astro-r6rcksuz">Design</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/dhh-rails-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">DHH Rails Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/every-style-editor/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Every Style Editor</span> <span class="sl-badge caution small  astro-2v7xa3ze astro-r6rcksuz">Workflow</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/figma-design-sync/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Figma Design Sync</span> <span class="sl-badge tip small  astro-2v7xa3ze astro-r6rcksuz">Design</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/framework-docs-researcher/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Framework Docs Researcher</span> <span class="sl-badge success small  astro-2v7xa3ze astro-r6rcksuz">Research</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/git-history-analyzer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Git History Analyzer</span> <span class="sl-badge success small  astro-2v7xa3ze astro-r6rcksuz">Research</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/julik-frontend-races-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Julik Frontend Races Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/kieran-python-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Kieran Python Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/kieran-rails-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Kieran Rails Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/kieran-typescript-reviewer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Kieran Typescript Reviewer</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/learnings-researcher/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Learnings Researcher</span> <span class="sl-badge success small  astro-2v7xa3ze astro-r6rcksuz">Research</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/lint/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Lint</span> <span class="sl-badge caution small  astro-2v7xa3ze astro-r6rcksuz">Workflow</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/pattern-recognition-specialist/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Pattern Recognition Specialist</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/performance-oracle/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Performance Oracle</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/pr-comment-resolver/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">PR Comment Resolver</span> <span class="sl-badge caution small  astro-2v7xa3ze astro-r6rcksuz">Workflow</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/repo-research-analyst/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Repo Research Analyst</span> <span class="sl-badge success small  astro-2v7xa3ze astro-r6rcksuz">Research</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/schema-drift-detector/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Schema Drift Detector</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/security-sentinel/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Security Sentinel</span> <span class="sl-badge note small  astro-2v7xa3ze astro-r6rcksuz">Review</span> </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/agents/spec-flow-analyzer/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Spec Flow Analyzer</span> <span class="sl-badge caution small  astro-2v7xa3ze astro-r6rcksuz">Workflow</span> </a> </li> </ul>  </details> </li><li class="astro-2v7xa3ze"> <details open class="astro-2v7xa3ze"> <summary class="astro-2v7xa3ze"> <span class="group-label astro-2v7xa3ze"> <span class="large astro-2v7xa3ze">Commands</span>  </span> <svg aria-hidden="true" class="caret astro-2v7xa3ze astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="5"></sl-sidebar-restore> <ul class="astro-2v7xa3ze"> <li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Commands Reference</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/agent-native-audit/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Agent Native Audit</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/changelog/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Changelog</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/create-agent-skill/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Create Agent Skill</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/deepen-plan/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Deepen Plan</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/deploy-docs/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Deploy Docs</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/feature-video/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Feature Video</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/generate-command/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Generate_command</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/heal-skill/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Heal Skill</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/lfg/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Lfg</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/report-bug/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Report Bug</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/reproduce-bug/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Reproduce Bug</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/resolve-parallel/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Resolve_parallel</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/resolve-todo-parallel/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Resolve_todo_parallel</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/slfg/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Slfg</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/test-browser/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Test Browser</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/test-xcode/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Test Xcode</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/triage/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Triage</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/workflows-brainstorm/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Workflows: Brainstorm</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/workflows-compound/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Workflows: Compound</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/workflows-plan/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Workflows: Plan</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/workflows-review/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Workflows: Review</span>  </a> </li><li class="astro-2v7xa3ze"> <a href="/systematic/reference/commands/workflows-work/" class="astro-2v7xa3ze"> <span class="astro-2v7xa3ze">Workflows: Work</span>  </a> </li> </ul>  </details> </li> </ul>  </details> </li> </ul>   <script aria-hidden="true">
		(() => {
			const scroller = document.getElementById('starlight__sidebar');
			if (!window._starlightScrollRestore || !scroller) return;
			scroller.scrollTop = window._starlightScrollRestore;
			delete window._starlightScrollRestore;
		})();
	</script> </sl-sidebar-state-persist>  <div class="md:sl-hidden"> <div class="mobile-preferences sl-flex astro-evq6jdvn"> <div class="social-icons astro-evq6jdvn"> <a href="https://github.com/marcusrbrown/systematic" rel="me" class="sl-flex astro-slnfz65f"><span class="sr-only astro-slnfz65f">GitHub</span><svg aria-hidden="true" class="astro-slnfz65f astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg></a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-afb54k27"> <span class="sr-only astro-afb54k27">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-afb54k27 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select autocomplete="off" class="astro-afb54k27"> <option value="dark" class="astro-afb54k27">Dark</option><option value="light" class="astro-afb54k27">Light</option><option value="auto" selected class="astro-afb54k27">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-afb54k27 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg> </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script>   </div>  </div> </div> </div> </nav> <div class="main-frame astro-r6lv7f2i">  <script type="module">const a=document.getElementById("starlight__sidebar"),n=a?.querySelector("sl-sidebar-state-persist"),o="sl-sidebar-state",i=()=>{let t=[];const e=n?.dataset.hash||"";try{const s=sessionStorage.getItem(o),r=JSON.parse(s||"{}");Array.isArray(r.open)&&r.hash===e&&(t=r.open)}catch{}return{hash:e,open:t,scroll:a?.scrollTop||0}},c=t=>{try{sessionStorage.setItem(o,JSON.stringify(t))}catch{}},d=()=>c(i()),l=(t,e)=>{const s=i();s.open[e]=t,c(s)};n?.addEventListener("click",t=>{if(!(t.target instanceof Element))return;const e=t.target.closest("summary")?.closest("details");if(!e)return;const s=e.querySelector("sl-sidebar-restore"),r=parseInt(s?.dataset.index||"");isNaN(r)||l(!e.open,r)});addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&d()});addEventListener("pageHide",d);</script> <div class="lg:sl-flex astro-5o6snv62"> <aside class="right-sidebar-container print:hidden astro-5o6snv62"> <div class="right-sidebar astro-5o6snv62"> <script type="module" src="/systematic/_astro/MobileTableOfContents.astro_astro_type_script_index_0_lang.hwBsy0Mo.js"></script><script type="module" src="/systematic/_astro/TableOfContents.astro_astro_type_script_index_0_lang.FuRcXuRY.js"></script><div class="lg:sl-hidden astro-dnoxkmvf"><mobile-starlight-toc data-min-h="2" data-max-h="3" class="astro-mqifc7lk"><nav aria-labelledby="starlight__on-this-page--mobile" class="astro-mqifc7lk"><details id="starlight__mobile-toc" class="astro-mqifc7lk"><summary id="starlight__on-this-page--mobile" class="sl-flex astro-mqifc7lk"><span class="toggle sl-flex astro-mqifc7lk">On this page<svg aria-hidden="true" class="caret astro-mqifc7lk astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></span><span class="display-current astro-mqifc7lk"></span></summary><div class="dropdown astro-mqifc7lk"><ul class="isMobile astro-tqutraay" style="--depth: 0;"> <li class="astro-tqutraay" style="--depth: 0;"> <a href="#_top" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#overview" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#core-concepts" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Core Concepts</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#1-signatures" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">1. Signatures</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#2-modules" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">2. Modules</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#3-tools--toolsets" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">3. Tools &amp; Toolsets</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#4-type-system--discriminators" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">4. Type System &amp; Discriminators</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#5-optimization" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">5. Optimization</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#quick-start" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Quick Start</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#provider-adapter-gems" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Provider Adapter Gems</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#per-provider-adapters-direct-sdk-access" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Per-provider adapters (direct SDK access)</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#unified-adapter-via-rubyllm-recommended-for-multi-provider" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Unified adapter via RubyLLM (recommended for multi-provider)</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#events-system" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Events System</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#module-scoped-subscriptions-preferred-for-agents" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Module-Scoped Subscriptions (preferred for agents)</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#global-subscriptions-for-observabilityintegrations" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Global Subscriptions (for observability/integrations)</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#lifecycle-callbacks" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Lifecycle Callbacks</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#fiber-local-lm-context" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Fiber-Local LM Context</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#evaluation-framework" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Evaluation Framework</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#gepa-optimization" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">GEPA Optimization</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#typed-context-pattern" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Typed Context Pattern</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#schema-formats-baml--toon" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Schema Formats (BAML / TOON)</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#storage-system" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Storage System</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#rails-integration" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Rails Integration</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#directory-structure" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Directory Structure</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#initializer" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Initializer</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#feature-flagged-model-selection" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Feature-Flagged Model Selection</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#schema-driven-signatures" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Schema-Driven Signatures</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#entities-as-shared-types" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Entities as Shared Types</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#schema-vs-description-when-to-use-each" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Schema vs Description: When to Use Each</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#tool-patterns" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Tool Patterns</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#tools-that-wrap-predictions" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Tools That Wrap Predictions</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#error-handling-concern" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Error Handling Concern</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#observability" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Observability</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#tracing-with-dspycontext" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Tracing with DSPy::Context</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#setup-for-langfuse" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Setup for Langfuse</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#score-reporting" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Score Reporting</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#testing" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Testing</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#vcr-setup-for-rails" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">VCR Setup for Rails</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#signature-schema-tests" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Signature Schema Tests</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#tool-tests-with-mocked-predictions" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Tool Tests with Mocked Predictions</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#resources" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Resources</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#key-urls" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Key URLs</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#guidelines-for-claude" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Guidelines for Claude</span> </a> <ul class="isMobile astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#signature-best-practices" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Signature Best Practices</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#recursive-types-with-defs" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Recursive Types with $defs</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#field-descriptions-for-tstruct" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Field Descriptions for T::Struct</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#version" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Version</span> </a>  </li> </ul> </div></details></nav></mobile-starlight-toc></div><div class="right-sidebar-panel sl-hidden lg:sl-block astro-dnoxkmvf"><div class="sl-container astro-dnoxkmvf"><starlight-toc data-min-h="2" data-max-h="3"><nav aria-labelledby="starlight__on-this-page"><h2 id="starlight__on-this-page">On this page</h2><ul class="astro-tqutraay" style="--depth: 0;"> <li class="astro-tqutraay" style="--depth: 0;"> <a href="#_top" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#overview" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#core-concepts" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Core Concepts</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#1-signatures" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">1. Signatures</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#2-modules" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">2. Modules</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#3-tools--toolsets" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">3. Tools &amp; Toolsets</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#4-type-system--discriminators" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">4. Type System &amp; Discriminators</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#5-optimization" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">5. Optimization</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#quick-start" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Quick Start</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#provider-adapter-gems" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Provider Adapter Gems</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#per-provider-adapters-direct-sdk-access" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Per-provider adapters (direct SDK access)</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#unified-adapter-via-rubyllm-recommended-for-multi-provider" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Unified adapter via RubyLLM (recommended for multi-provider)</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#events-system" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Events System</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#module-scoped-subscriptions-preferred-for-agents" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Module-Scoped Subscriptions (preferred for agents)</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#global-subscriptions-for-observabilityintegrations" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Global Subscriptions (for observability/integrations)</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#lifecycle-callbacks" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Lifecycle Callbacks</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#fiber-local-lm-context" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Fiber-Local LM Context</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#evaluation-framework" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Evaluation Framework</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#gepa-optimization" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">GEPA Optimization</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#typed-context-pattern" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Typed Context Pattern</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#schema-formats-baml--toon" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Schema Formats (BAML / TOON)</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#storage-system" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Storage System</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#rails-integration" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Rails Integration</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#directory-structure" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Directory Structure</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#initializer" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Initializer</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#feature-flagged-model-selection" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Feature-Flagged Model Selection</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#schema-driven-signatures" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Schema-Driven Signatures</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#entities-as-shared-types" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Entities as Shared Types</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#schema-vs-description-when-to-use-each" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Schema vs Description: When to Use Each</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#tool-patterns" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Tool Patterns</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#tools-that-wrap-predictions" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Tools That Wrap Predictions</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#error-handling-concern" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Error Handling Concern</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#observability" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Observability</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#tracing-with-dspycontext" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Tracing with DSPy::Context</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#setup-for-langfuse" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Setup for Langfuse</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#score-reporting" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Score Reporting</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#testing" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Testing</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#vcr-setup-for-rails" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">VCR Setup for Rails</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#signature-schema-tests" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Signature Schema Tests</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#tool-tests-with-mocked-predictions" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Tool Tests with Mocked Predictions</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#resources" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Resources</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#key-urls" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Key URLs</span> </a>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#guidelines-for-claude" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Guidelines for Claude</span> </a> <ul class="astro-tqutraay" style="--depth: 1;"> <li class="astro-tqutraay" style="--depth: 1;"> <a href="#signature-best-practices" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Signature Best Practices</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#recursive-types-with-defs" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Recursive Types with $defs</span> </a>  </li><li class="astro-tqutraay" style="--depth: 1;"> <a href="#field-descriptions-for-tstruct" class="astro-tqutraay" style="--depth: 1;"> <span class="astro-tqutraay" style="--depth: 1;">Field Descriptions for T::Struct</span> </a>  </li> </ul>  </li><li class="astro-tqutraay" style="--depth: 0;"> <a href="#version" class="astro-tqutraay" style="--depth: 0;"> <span class="astro-tqutraay" style="--depth: 0;">Version</span> </a>  </li> </ul> </nav></starlight-toc></div></div> </div> </aside> <div class="main-pane astro-5o6snv62">  <main data-pagefind-body class="astro-aiylphlt" lang="en" dir="ltr">    <div class="content-panel astro-yu6egeco"> <div class="sl-container astro-yu6egeco"> <h1 id="_top" class="astro-ty5wsixp">Dspy Ruby</h1>  </div> </div>  <div class="content-panel astro-yu6egeco"> <div class="sl-container astro-yu6egeco"> <div class="sl-markdown-content"> <div class="definition-header not-content">
  <a class="definition-source" href="https://github.com/marcusrbrown/systematic/blob/main/skills/dspy-ruby/SKILL.md">View source</a>
</div>
<div class="sl-heading-wrapper level-h1"><h1 id="dspyrb">DSPy.rb</h1><a class="sl-anchor-link" href="#dspyrb"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “DSPy.rb”</span></a></div>
<blockquote>
<p>Build LLM apps like you build software. Type-safe, modular, testable.</p>
</blockquote>
<p>DSPy.rb brings software engineering best practices to LLM development. Instead of tweaking prompts, define what you want with Ruby types and let DSPy handle the rest.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="overview">Overview</h2><a class="sl-anchor-link" href="#overview"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Overview”</span></a></div>
<p>DSPy.rb is a Ruby framework for building language model applications with programmatic prompts. It provides:</p>
<ul>
<li><strong>Type-safe signatures</strong> — Define inputs/outputs with Sorbet types</li>
<li><strong>Modular components</strong> — Compose and reuse LLM logic</li>
<li><strong>Automatic optimization</strong> — Use data to improve prompts, not guesswork</li>
<li><strong>Production-ready</strong> — Built-in observability, testing, and error handling</li>
</ul>
<div class="sl-heading-wrapper level-h2"><h2 id="core-concepts">Core Concepts</h2><a class="sl-anchor-link" href="#core-concepts"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Core Concepts”</span></a></div>
<div class="sl-heading-wrapper level-h3"><h3 id="1-signatures">1. Signatures</h3><a class="sl-anchor-link" href="#1-signatures"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “1. Signatures”</span></a></div>
<p>Define interfaces between your app and LLMs using Ruby types:</p>
<div class="expressive-code"><link rel="stylesheet" href="/systematic/_astro/ec.v4551.css"><script type="module" src="/systematic/_astro/ec.0vx5m.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">EmailClassifier</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Signature</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">description </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Classify customer support emails by category and priority</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">Priority</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Enum</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">enums </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Low</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">low</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Medium</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">medium</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">High</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">high</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Urgent</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">urgent</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">input </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">email_content</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">sender</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">output </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">category</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">priority</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Priority</span><span style="--0:#D6DEEB;--1:#403F53">  </span><span style="--0:#919F9F;--1:#5F636F"># Type-safe enum with defined values</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">confidence</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Float</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class EmailClassifier < DSPy::Signature  description &#x22;Classify customer support emails by category and priority&#x22;  class Priority < T::Enum    enums do      Low = new(&#x27;low&#x27;)      Medium = new(&#x27;medium&#x27;)      High = new(&#x27;high&#x27;)      Urgent = new(&#x27;urgent&#x27;)    end  end  input do    const :email_content, String    const :sender, String  end  output do    const :category, String    const :priority, Priority  # Type-safe enum with defined values    const :confidence, Float  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="2-modules">2. Modules</h3><a class="sl-anchor-link" href="#2-modules"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “2. Modules”</span></a></div>
<p>Build complex workflows from simple building blocks:</p>
<ul>
<li><strong>Predict</strong> — Basic LLM calls with signatures</li>
<li><strong>ChainOfThought</strong> — Step-by-step reasoning</li>
<li><strong>ReAct</strong> — Tool-using agents</li>
<li><strong>CodeAct</strong> — Dynamic code generation agents (install the <code dir="auto">dspy-code_act</code> gem)</li>
</ul>
<div class="sl-heading-wrapper level-h3"><h3 id="3-tools--toolsets">3. Tools &#x26; Toolsets</h3><a class="sl-anchor-link" href="#3-tools--toolsets"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “3. Tools &#x26; Toolsets”</span></a></div>
<p>Create type-safe tools for agents with comprehensive Sorbet support:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Enum-based tool with automatic type conversion</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">CalculatorTool</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Tools::Base</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">tool_name </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">calculator</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">tool_description </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">Performs arithmetic operations with type-safe enum inputs</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">Operation</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Enum</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">enums </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Add</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">add</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Subtract</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">subtract</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Multiply</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">multiply</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">Divide</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">divide</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">sig { </span><span style="--0:#82AAFF;--1:#3B61B0">params(</span><span style="--0:#7FDBCA;--1:#096E72">operation</span><span style="--0:#82AAFF;--1:#3B61B0">: Operation, </span><span style="--0:#7FDBCA;--1:#096E72">num1</span><span style="--0:#82AAFF;--1:#3B61B0">: Float, </span><span style="--0:#7FDBCA;--1:#096E72">num2</span><span style="--0:#82AAFF;--1:#3B61B0">: Float)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">returns</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">any</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">Float</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">)) }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#82AAFF;--1:#3B61B0">operation:</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">num1:</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">num2:</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">case</span><span style="--0:#D6DEEB;--1:#403F53"> operation</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">when</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Operation</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Add</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">then</span><span style="--0:#D6DEEB;--1:#403F53"> num1 </span><span style="--0:#C792EA;--1:#8844AE">+</span><span style="--0:#D6DEEB;--1:#403F53"> num2</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">when</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Operation</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Subtract</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">then</span><span style="--0:#D6DEEB;--1:#403F53"> num1 </span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53"> num2</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">when</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Operation</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Multiply</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">then</span><span style="--0:#D6DEEB;--1:#403F53"> num1 </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#D6DEEB;--1:#403F53"> num2</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">when</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Operation</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Divide</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#C792EA;--1:#8844AE">return</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Error: Division by zero</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> num2 </span><span style="--0:#C792EA;--1:#8844AE">==</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">      </span></span><span style="--0:#D6DEEB;--1:#403F53">num1 </span><span style="--0:#C792EA;--1:#8844AE">/</span><span style="--0:#D6DEEB;--1:#403F53"> num2</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Multi-tool toolset with rich types</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">DataToolset</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Tools::Toolset</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">toolset_name </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">data_processing</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">Format</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Enum</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">enums </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">JSON</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">json</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">CSV</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">csv</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#82AAFF;--1:#3B61B0">XML</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">xml</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">tool </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">convert</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Convert data between formats</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">tool </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">validate</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Validate data structure</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">sig { </span><span style="--0:#82AAFF;--1:#3B61B0">params(</span><span style="--0:#7FDBCA;--1:#096E72">data</span><span style="--0:#82AAFF;--1:#3B61B0">: String, </span><span style="--0:#7FDBCA;--1:#096E72">from</span><span style="--0:#82AAFF;--1:#3B61B0">: Format, </span><span style="--0:#7FDBCA;--1:#096E72">to</span><span style="--0:#82AAFF;--1:#3B61B0">: Format)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">returns</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">) }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">convert</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#82AAFF;--1:#3B61B0">data:</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">from:</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">to:</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Converted from </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">from.</span><span style="--0:#82AAFF;--1:#3B61B0">serialize</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#ECC48D;--1:#984E4D"> to </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">to.</span><span style="--0:#82AAFF;--1:#3B61B0">serialize</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">sig { </span><span style="--0:#82AAFF;--1:#3B61B0">params(</span><span style="--0:#7FDBCA;--1:#096E72">data</span><span style="--0:#82AAFF;--1:#3B61B0">: String, </span><span style="--0:#7FDBCA;--1:#096E72">format</span><span style="--0:#82AAFF;--1:#3B61B0">: Format)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">returns</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Hash</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">any</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Integer</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Boolean</span><span style="--0:#D6DEEB;--1:#403F53">)]) }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">validate</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#82AAFF;--1:#3B61B0">data:</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">format:</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">{ </span><span style="--0:#7FDBCA;--1:#096E72">valid</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">format</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">format</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">serialize</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">row_count</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">42</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">message</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Data validation passed</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Enum-based tool with automatic type conversionclass CalculatorTool < DSPy::Tools::Base  tool_name &#x27;calculator&#x27;  tool_description &#x27;Performs arithmetic operations with type-safe enum inputs&#x27;  class Operation < T::Enum    enums do      Add = new(&#x27;add&#x27;)      Subtract = new(&#x27;subtract&#x27;)      Multiply = new(&#x27;multiply&#x27;)      Divide = new(&#x27;divide&#x27;)    end  end  sig { params(operation: Operation, num1: Float, num2: Float).returns(T.any(Float, String)) }  def call(operation:, num1:, num2:)    case operation    when Operation::Add then num1 + num2    when Operation::Subtract then num1 - num2    when Operation::Multiply then num1 * num2    when Operation::Divide      return &#x22;Error: Division by zero&#x22; if num2 == 0      num1 / num2    end  endend# Multi-tool toolset with rich typesclass DataToolset < DSPy::Tools::Toolset  toolset_name &#x22;data_processing&#x22;  class Format < T::Enum    enums do      JSON = new(&#x27;json&#x27;)      CSV = new(&#x27;csv&#x27;)      XML = new(&#x27;xml&#x27;)    end  end  tool :convert, description: &#x22;Convert data between formats&#x22;  tool :validate, description: &#x22;Validate data structure&#x22;  sig { params(data: String, from: Format, to: Format).returns(String) }  def convert(data:, from:, to:)    &#x22;Converted from #{from.serialize} to #{to.serialize}&#x22;  end  sig { params(data: String, format: Format).returns(T::Hash[String, T.any(String, Integer, T::Boolean)]) }  def validate(data:, format:)    { valid: true, format: format.serialize, row_count: 42, message: &#x22;Data validation passed&#x22; }  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="4-type-system--discriminators">4. Type System &#x26; Discriminators</h3><a class="sl-anchor-link" href="#4-type-system--discriminators"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “4. Type System &#x26; Discriminators”</span></a></div>
<p>DSPy.rb uses sophisticated type discrimination for complex data structures:</p>
<ul>
<li><strong>Automatic <code dir="auto">_type</code> field injection</strong> — DSPy adds discriminator fields to structs for type safety</li>
<li><strong>Union type support</strong> — <code dir="auto">T.any()</code> types automatically disambiguated by <code dir="auto">_type</code></li>
<li><strong>Reserved field name</strong> — Avoid defining your own <code dir="auto">_type</code> fields in structs</li>
<li><strong>Recursive filtering</strong> — <code dir="auto">_type</code> fields filtered during deserialization at all nesting levels</li>
</ul>
<div class="sl-heading-wrapper level-h3"><h3 id="5-optimization">5. Optimization</h3><a class="sl-anchor-link" href="#5-optimization"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “5. Optimization”</span></a></div>
<p>Improve accuracy with real data:</p>
<ul>
<li><strong>MIPROv2</strong> — Advanced multi-prompt optimization with bootstrap sampling and Bayesian optimization</li>
<li><strong>GEPA</strong> — Genetic-Pareto Reflective Prompt Evolution with feedback maps, experiment tracking, and telemetry</li>
<li><strong>Evaluation</strong> — Comprehensive framework with built-in and custom metrics, error handling, and batch processing</li>
</ul>
<div class="sl-heading-wrapper level-h2"><h2 id="quick-start">Quick Start</h2><a class="sl-anchor-link" href="#quick-start"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Quick Start”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Install</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Configure</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span><span style="--0:#D6DEEB;--1:#403F53"> |</span><span style="--0:#C5E478;--1:#3B61B0">c</span><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">c.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">LM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">openai/gpt-4o-mini</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">api_key</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">OPENAI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">])</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Define a task</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">SentimentAnalysis</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Signature</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">description </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Analyze sentiment of text</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">input </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">text</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">output </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">sentiment</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">  </span><span style="--0:#919F9F;--1:#5F636F"># positive, negative, neutral</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">score</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Float</span><span style="--0:#D6DEEB;--1:#403F53">       </span><span style="--0:#919F9F;--1:#5F636F"># 0.0 to 1.0</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Use it</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">analyzer</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Predict</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">SentimentAnalysis</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> analyzer.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">text</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">This product is amazing!</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">puts</span><span style="--0:#D6DEEB;--1:#403F53"> result.</span><span style="--0:#82AAFF;--1:#3B61B0">sentiment</span><span style="--0:#D6DEEB;--1:#403F53">  </span><span style="--0:#919F9F;--1:#5F636F"># => "positive"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">puts</span><span style="--0:#D6DEEB;--1:#403F53"> result.</span><span style="--0:#82AAFF;--1:#3B61B0">score</span><span style="--0:#D6DEEB;--1:#403F53">      </span><span style="--0:#919F9F;--1:#5F636F"># => 0.92</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Installgem &#x27;dspy&#x27;# ConfigureDSPy.configure do |c|  c.lm = DSPy::LM.new(&#x27;openai/gpt-4o-mini&#x27;, api_key: ENV[&#x27;OPENAI_API_KEY&#x27;])end# Define a taskclass SentimentAnalysis < DSPy::Signature  description &#x22;Analyze sentiment of text&#x22;  input do    const :text, String  end  output do    const :sentiment, String  # positive, negative, neutral    const :score, Float       # 0.0 to 1.0  endend# Use itanalyzer = DSPy::Predict.new(SentimentAnalysis)result = analyzer.call(text: &#x22;This product is amazing!&#x22;)puts result.sentiment  # => &#x22;positive&#x22;puts result.score      # => 0.92"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="provider-adapter-gems">Provider Adapter Gems</h2><a class="sl-anchor-link" href="#provider-adapter-gems"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Provider Adapter Gems”</span></a></div>
<p>Two strategies for connecting to LLM providers:</p>
<div class="sl-heading-wrapper level-h3"><h3 id="per-provider-adapters-direct-sdk-access">Per-provider adapters (direct SDK access)</h3><a class="sl-anchor-link" href="#per-provider-adapters-direct-sdk-access"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Per-provider adapters (direct SDK access)”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Gemfile</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-openai</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#919F9F;--1:#5F636F"># OpenAI, OpenRouter, Ollama</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-anthropic</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#919F9F;--1:#5F636F"># Claude</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-gemini</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#919F9F;--1:#5F636F"># Gemini</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Gemfilegem &#x27;dspy&#x27;gem &#x27;dspy-openai&#x27;    # OpenAI, OpenRouter, Ollamagem &#x27;dspy-anthropic&#x27; # Claudegem &#x27;dspy-gemini&#x27;    # Gemini"><div></div></button></div></figure></div>
<p>Each adapter gem pulls in the official SDK (<code dir="auto">openai</code>, <code dir="auto">anthropic</code>, <code dir="auto">gemini-ai</code>).</p>
<div class="sl-heading-wrapper level-h3"><h3 id="unified-adapter-via-rubyllm-recommended-for-multi-provider">Unified adapter via RubyLLM (recommended for multi-provider)</h3><a class="sl-anchor-link" href="#unified-adapter-via-rubyllm-recommended-for-multi-provider"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Unified adapter via RubyLLM (recommended for multi-provider)”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Gemfile</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-ruby_llm</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">  </span><span style="--0:#919F9F;--1:#5F636F"># Routes to any provider via ruby_llm</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">ruby_llm</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Gemfilegem &#x27;dspy&#x27;gem &#x27;dspy-ruby_llm&#x27;  # Routes to any provider via ruby_llmgem &#x27;ruby_llm&#x27;"><div></div></button></div></figure></div>
<p>RubyLLM handles provider routing based on the model name. Use the <code dir="auto">ruby_llm/</code> prefix:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span><span style="--0:#D6DEEB;--1:#403F53"> |</span><span style="--0:#C5E478;--1:#3B61B0">c</span><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">c.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">LM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">ruby_llm/gemini-2.5-flash</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">structured_outputs</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#919F9F;--1:#5F636F"># c.lm = DSPy::LM.new('ruby_llm/claude-sonnet-4-20250514', structured_outputs: true)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#919F9F;--1:#5F636F"># c.lm = DSPy::LM.new('ruby_llm/gpt-4o-mini', structured_outputs: true)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="DSPy.configure do |c|  c.lm = DSPy::LM.new(&#x27;ruby_llm/gemini-2.5-flash&#x27;, structured_outputs: true)  # c.lm = DSPy::LM.new(&#x27;ruby_llm/claude-sonnet-4-20250514&#x27;, structured_outputs: true)  # c.lm = DSPy::LM.new(&#x27;ruby_llm/gpt-4o-mini&#x27;, structured_outputs: true)end"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="events-system">Events System</h2><a class="sl-anchor-link" href="#events-system"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Events System”</span></a></div>
<p>DSPy.rb ships with a structured event bus for observing runtime behavior.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="module-scoped-subscriptions-preferred-for-agents">Module-Scoped Subscriptions (preferred for agents)</h3><a class="sl-anchor-link" href="#module-scoped-subscriptions-preferred-for-agents"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Module-Scoped Subscriptions (preferred for agents)”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">MyAgent</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Module</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">subscribe </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">lm.tokens</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">track_tokens</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">scope</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">descendants</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">track_tokens</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#7FDBCA;--1:#096E72">_event</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">attrs</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#7FDBCA;--1:#096E72">@total_tokens</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">+=</span><span style="--0:#D6DEEB;--1:#403F53"> attrs.</span><span style="--0:#82AAFF;--1:#3B61B0">fetch</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">total_tokens</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class MyAgent < DSPy::Module  subscribe &#x27;lm.tokens&#x27;, :track_tokens, scope: :descendants  def track_tokens(_event, attrs)    @total_tokens += attrs.fetch(:total_tokens, 0)  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="global-subscriptions-for-observabilityintegrations">Global Subscriptions (for observability/integrations)</h3><a class="sl-anchor-link" href="#global-subscriptions-for-observabilityintegrations"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Global Subscriptions (for observability/integrations)”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">subscription_id</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">events</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">subscribe</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">score.create</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#C792EA;--1:#8844AE">do</span><span style="--0:#D6DEEB;--1:#403F53"> |</span><span style="--0:#C5E478;--1:#3B61B0">event</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">attrs</span><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">Langfuse</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">export_score</span><span style="--0:#D6DEEB;--1:#403F53">(attrs)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Wildcards supported</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">events</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">subscribe</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">llm.*</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">) { |</span><span style="--0:#C5E478;--1:#3B61B0">name</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">attrs</span><span style="--0:#D6DEEB;--1:#403F53">| </span><span style="--0:#C5E478;--1:#3B61B0">puts</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">[</span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">name</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#ECC48D;--1:#984E4D">] tokens=</span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">attrs</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">total_tokens</span><span style="--0:#D6DEEB;--1:#403F53">]</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> }</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="subscription_id = DSPy.events.subscribe(&#x27;score.create&#x27;) do |event, attrs|  Langfuse.export_score(attrs)end# Wildcards supportedDSPy.events.subscribe(&#x27;llm.*&#x27;) { |name, attrs| puts &#x22;[#{name}] tokens=#{attrs[:total_tokens]}&#x22; }"><div></div></button></div></figure></div>
<p>Event names use dot-separated namespaces (<code dir="auto">llm.generate</code>, <code dir="auto">react.iteration_complete</code>). Every event includes module metadata (<code dir="auto">module_path</code>, <code dir="auto">module_leaf</code>, <code dir="auto">module_scope.ancestry_token</code>) for filtering.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="lifecycle-callbacks">Lifecycle Callbacks</h2><a class="sl-anchor-link" href="#lifecycle-callbacks"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Lifecycle Callbacks”</span></a></div>
<p>Rails-style lifecycle hooks ship with every <code dir="auto">DSPy::Module</code>:</p>
<ul>
<li><strong><code dir="auto">before</code></strong> — Runs ahead of <code dir="auto">forward</code> for setup (metrics, context loading)</li>
<li><strong><code dir="auto">around</code></strong> — Wraps <code dir="auto">forward</code>, calls <code dir="auto">yield</code>, and lets you pair setup/teardown logic</li>
<li><strong><code dir="auto">after</code></strong> — Fires after <code dir="auto">forward</code> returns for cleanup or persistence</li>
</ul>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">InstrumentedModule</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Module</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">before </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">setup_metrics</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">around </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">manage_context</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">after </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">log_metrics</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">forward</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#82AAFF;--1:#3B61B0">question:</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#7FDBCA;--1:#096E72">@predictor</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">question</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> question)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">private</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">setup_metrics</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#7FDBCA;--1:#096E72">@start_time</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Time</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">now</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">manage_context</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">load_context</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">yield</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">save_context</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">result</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">log_metrics</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">duration</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Time</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">now</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">@start_time</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">logger</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">info</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Prediction completed in </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">duration</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#ECC48D;--1:#984E4D">s</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class InstrumentedModule < DSPy::Module  before :setup_metrics  around :manage_context  after :log_metrics  def forward(question:)    @predictor.call(question: question)  end  private  def setup_metrics    @start_time = Time.now  end  def manage_context    load_context    result = yield    save_context    result  end  def log_metrics    duration = Time.now - @start_time    Rails.logger.info &#x22;Prediction completed in #{duration}s&#x22;  endend"><div></div></button></div></figure></div>
<p>Execution order: before → around (before yield) → forward → around (after yield) → after. Callbacks are inherited from parent classes and execute in registration order.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="fiber-local-lm-context">Fiber-Local LM Context</h2><a class="sl-anchor-link" href="#fiber-local-lm-context"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Fiber-Local LM Context”</span></a></div>
<p>Override the language model temporarily using fiber-local storage:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">fast_model</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">LM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">openai/gpt-4o-mini</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">api_key</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">OPENAI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">])</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">with_lm</span><span style="--0:#D6DEEB;--1:#403F53">(fast_model) </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> classifier.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">text</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">test</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)  </span><span style="--0:#919F9F;--1:#5F636F"># Uses fast_model inside this block</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Back to global LM outside the block</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="fast_model = DSPy::LM.new(&#x22;openai/gpt-4o-mini&#x22;, api_key: ENV[&#x27;OPENAI_API_KEY&#x27;])DSPy.with_lm(fast_model) do  result = classifier.call(text: &#x22;test&#x22;)  # Uses fast_model inside this blockend# Back to global LM outside the block"><div></div></button></div></figure></div>
<p><strong>LM resolution hierarchy</strong>: Instance-level LM → Fiber-local LM (<code dir="auto">DSPy.with_lm</code>) → Global LM (<code dir="auto">DSPy.configure</code>).</p>
<p>Use <code dir="auto">configure_predictor</code> for fine-grained control over agent internals:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">agent</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">ReAct</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">MySignature</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">tools</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> tools)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">agent.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> { |</span><span style="--0:#C5E478;--1:#3B61B0">c</span><span style="--0:#D6DEEB;--1:#403F53">| c.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> default_model }</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">agent.</span><span style="--0:#82AAFF;--1:#3B61B0">configure_predictor</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">thought_generator</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">) { |</span><span style="--0:#C5E478;--1:#3B61B0">c</span><span style="--0:#D6DEEB;--1:#403F53">| c.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> powerful_model }</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="agent = DSPy::ReAct.new(MySignature, tools: tools)agent.configure { |c| c.lm = default_model }agent.configure_predictor(&#x27;thought_generator&#x27;) { |c| c.lm = powerful_model }"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="evaluation-framework">Evaluation Framework</h2><a class="sl-anchor-link" href="#evaluation-framework"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Evaluation Framework”</span></a></div>
<p>Systematically test LLM application performance with <code dir="auto">DSPy::Evals</code>:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">metric</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Metrics</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">exact_match</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">field</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">answer</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">case_sensitive</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">false</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">evaluator</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Evals</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(predictor, </span><span style="--0:#7FDBCA;--1:#096E72">metric</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> metric)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> evaluator.</span><span style="--0:#82AAFF;--1:#3B61B0">evaluate</span><span style="--0:#D6DEEB;--1:#403F53">(test_examples, </span><span style="--0:#7FDBCA;--1:#096E72">display_table</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">puts</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Pass Rate: </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">(result.</span><span style="--0:#82AAFF;--1:#3B61B0">pass_rate</span><span style="--0:#ECC48D;--1:#984E4D"> </span><span style="--0:#C792EA;--1:#8844AE">*</span><span style="--0:#ECC48D;--1:#984E4D"> </span><span style="--0:#F78C6C;--1:#AA0982">100</span><span style="--0:#ECC48D;--1:#984E4D">).</span><span style="--0:#82AAFF;--1:#3B61B0">round</span><span style="--0:#ECC48D;--1:#984E4D">(</span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#ECC48D;--1:#984E4D">)</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#ECC48D;--1:#984E4D">%</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="metric = DSPy::Metrics.exact_match(field: :answer, case_sensitive: false)evaluator = DSPy::Evals.new(predictor, metric: metric)result = evaluator.evaluate(test_examples, display_table: true)puts &#x22;Pass Rate: #{(result.pass_rate * 100).round(1)}%&#x22;"><div></div></button></div></figure></div>
<p>Built-in metrics: <code dir="auto">exact_match</code>, <code dir="auto">contains</code>, <code dir="auto">numeric_difference</code>, <code dir="auto">composite_and</code>. Custom metrics return <code dir="auto">true</code>/<code dir="auto">false</code> or a <code dir="auto">DSPy::Prediction</code> with <code dir="auto">score:</code> and <code dir="auto">feedback:</code> fields.</p>
<p>Use <code dir="auto">DSPy::Example</code> for typed test data and <code dir="auto">export_scores: true</code> to push results to Langfuse.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="gepa-optimization">GEPA Optimization</h2><a class="sl-anchor-link" href="#gepa-optimization"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “GEPA Optimization”</span></a></div>
<p>GEPA (Genetic-Pareto Reflective Prompt Evolution) uses reflection-driven instruction rewrites:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-gepa</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">teleprompter</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Teleprompt</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">GEPA</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">metric</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> metric,</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">reflection_lm</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">ReflectionLM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">openai/gpt-4o-mini</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">api_key</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">OPENAI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">]),</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">feedback_map</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> feedback_map,</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">config</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> { </span><span style="--0:#7FDBCA;--1:#096E72">max_metric_calls</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">600</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">minibatch_size</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">6</span><span style="--0:#D6DEEB;--1:#403F53"> }</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> teleprompter.</span><span style="--0:#82AAFF;--1:#3B61B0">compile</span><span style="--0:#D6DEEB;--1:#403F53">(program, </span><span style="--0:#7FDBCA;--1:#096E72">trainset</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> train, </span><span style="--0:#7FDBCA;--1:#096E72">valset</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> val)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">optimized_program</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> result.</span><span style="--0:#82AAFF;--1:#3B61B0">optimized_program</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="gem &#x27;dspy-gepa&#x27;teleprompter = DSPy::Teleprompt::GEPA.new(  metric: metric,  reflection_lm: DSPy::ReflectionLM.new(&#x27;openai/gpt-4o-mini&#x27;, api_key: ENV[&#x27;OPENAI_API_KEY&#x27;]),  feedback_map: feedback_map,  config: { max_metric_calls: 600, minibatch_size: 6 })result = teleprompter.compile(program, trainset: train, valset: val)optimized_program = result.optimized_program"><div></div></button></div></figure></div>
<p>The metric must return <code dir="auto">DSPy::Prediction.new(score:, feedback:)</code> so the reflection model can reason about failures. Use <code dir="auto">feedback_map</code> to target individual predictors in composite modules.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="typed-context-pattern">Typed Context Pattern</h2><a class="sl-anchor-link" href="#typed-context-pattern"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Typed Context Pattern”</span></a></div>
<p>Replace opaque string context blobs with <code dir="auto">T::Struct</code> inputs. Each field gets its own <code dir="auto">description:</code> annotation in the JSON schema the LLM sees:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">NavigationContext</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Struct</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">workflow_hint</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">nilable</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Current workflow phase guidance for the agent</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">action_log</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Array</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">], </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> [],</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Compact one-line-per-action history of research steps taken</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">iterations_remaining</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Integer</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Budget remaining. Each tool call costs 1 iteration.</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">ToolSelectionSignature</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Signature</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">input </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">query</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">context</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">NavigationContext</span><span style="--0:#D6DEEB;--1:#403F53">  </span><span style="--0:#919F9F;--1:#5F636F"># Structured, not an opaque string</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">output </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">tool_name</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">tool_args</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">JSON-encoded arguments</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class NavigationContext < T::Struct  const :workflow_hint, T.nilable(String),        description: &#x22;Current workflow phase guidance for the agent&#x22;  const :action_log, T::Array[String], default: [],        description: &#x22;Compact one-line-per-action history of research steps taken&#x22;  const :iterations_remaining, Integer,        description: &#x22;Budget remaining. Each tool call costs 1 iteration.&#x22;endclass ToolSelectionSignature < DSPy::Signature  input do    const :query, String    const :context, NavigationContext  # Structured, not an opaque string  end  output do    const :tool_name, String    const :tool_args, String, description: &#x22;JSON-encoded arguments&#x22;  endend"><div></div></button></div></figure></div>
<p>Benefits: type safety at compile time, per-field descriptions in the LLM schema, easy to test as value objects, extensible by adding <code dir="auto">const</code> declarations.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="schema-formats-baml--toon">Schema Formats (BAML / TOON)</h2><a class="sl-anchor-link" href="#schema-formats-baml--toon"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Schema Formats (BAML / TOON)”</span></a></div>
<p>Control how DSPy describes signature structure to the LLM:</p>
<ul>
<li><strong>JSON Schema</strong> (default) — Standard format, works with <code dir="auto">structured_outputs: true</code></li>
<li><strong>BAML</strong> (<code dir="auto">schema_format: :baml</code>) — 84% token reduction for Enhanced Prompting mode. Requires <code dir="auto">sorbet-baml</code> gem.</li>
<li><strong>TOON</strong> (<code dir="auto">schema_format: :toon, data_format: :toon</code>) — Table-oriented format for both schemas and data. Enhanced Prompting mode only.</li>
</ul>
<p>BAML and TOON apply only when <code dir="auto">structured_outputs: false</code>. With <code dir="auto">structured_outputs: true</code>, the provider receives JSON Schema directly.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="storage-system">Storage System</h2><a class="sl-anchor-link" href="#storage-system"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Storage System”</span></a></div>
<p>Persist and reload optimized programs with <code dir="auto">DSPy::Storage::ProgramStorage</code>:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">storage</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Storage</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">ProgramStorage</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">storage_path</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">./dspy_storage</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">storage.</span><span style="--0:#82AAFF;--1:#3B61B0">save_program</span><span style="--0:#D6DEEB;--1:#403F53">(result.</span><span style="--0:#82AAFF;--1:#3B61B0">optimized_program</span><span style="--0:#D6DEEB;--1:#403F53">, result, </span><span style="--0:#7FDBCA;--1:#096E72">metadata</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> { </span><span style="--0:#7FDBCA;--1:#096E72">optimizer</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">MIPROv2</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53"> })</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="storage = DSPy::Storage::ProgramStorage.new(storage_path: &#x22;./dspy_storage&#x22;)storage.save_program(result.optimized_program, result, metadata: { optimizer: &#x27;MIPROv2&#x27; })"><div></div></button></div></figure></div>
<p>Supports checkpoint management, optimization history tracking, and import/export between environments.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="rails-integration">Rails Integration</h2><a class="sl-anchor-link" href="#rails-integration"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Rails Integration”</span></a></div>
<div class="sl-heading-wrapper level-h3"><h3 id="directory-structure">Directory Structure</h3><a class="sl-anchor-link" href="#directory-structure"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Directory Structure”</span></a></div>
<p>Organize DSPy components using Rails conventions:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">app/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">entities/          # T::Struct types shared across signatures</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">signatures/        # DSPy::Signature definitions</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">tools/             # DSPy::Tools::Base implementations</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">concerns/        # Shared tool behaviors (error handling, etc.)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">modules/           # DSPy::Module orchestrators</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">services/          # Plain Ruby services that compose DSPy modules</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">config/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">initializers/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">dspy.rb          # DSPy + provider configuration</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">feature_flags.rb # Model selection per role</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">spec/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">signatures/        # Schema validation tests</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">tools/             # Tool unit tests</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">modules/           # Integration tests with VCR</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">vcr_cassettes/     # Recorded HTTP interactions</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="app/  entities/          # T::Struct types shared across signatures  signatures/        # DSPy::Signature definitions  tools/             # DSPy::Tools::Base implementations    concerns/        # Shared tool behaviors (error handling, etc.)  modules/           # DSPy::Module orchestrators  services/          # Plain Ruby services that compose DSPy modulesconfig/  initializers/    dspy.rb          # DSPy + provider configuration    feature_flags.rb # Model selection per rolespec/  signatures/        # Schema validation tests  tools/             # Tool unit tests  modules/           # Integration tests with VCR  vcr_cassettes/     # Recorded HTTP interactions"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="initializer">Initializer</h3><a class="sl-anchor-link" href="#initializer"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Initializer”</span></a></div>
<div class="expressive-code"><figure class="frame has-title not-content"><figcaption class="header"><span class="title">config/initializers/dspy.rb</span></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">application</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">after_initialize</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">next</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">env</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">test?</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;&#x26;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">DSPY_ENABLE_IN_TEST</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#82AAFF;--1:#3B61B0">blank?</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">RubyLLM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span><span style="--0:#D6DEEB;--1:#403F53"> |</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">gemini_api_key</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">GEMINI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">] </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">GEMINI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#82AAFF;--1:#3B61B0">present?</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">anthropic_api_key</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">ANTHROPIC_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">] </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">ANTHROPIC_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#82AAFF;--1:#3B61B0">present?</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">openai_api_key</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">OPENAI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">] </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">OPENAI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#82AAFF;--1:#3B61B0">present?</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">model</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">fetch</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">DSPY_MODEL</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">ruby_llm/gemini-2.5-flash</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span><span style="--0:#D6DEEB;--1:#403F53"> |</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">LM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(model, </span><span style="--0:#7FDBCA;--1:#096E72">structured_outputs</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">logger</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">logger</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#919F9F;--1:#5F636F"># Langfuse observability (optional)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">LANGFUSE_PUBLIC_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#82AAFF;--1:#3B61B0">present?</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x26;&#x26;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">LANGFUSE_SECRET_KEY</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">].</span><span style="--0:#82AAFF;--1:#3B61B0">present?</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Observability</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">configure!</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="Rails.application.config.after_initialize do  next if Rails.env.test? &#x26;&#x26; ENV[&#x22;DSPY_ENABLE_IN_TEST&#x22;].blank?  RubyLLM.configure do |config|    config.gemini_api_key = ENV[&#x22;GEMINI_API_KEY&#x22;] if ENV[&#x22;GEMINI_API_KEY&#x22;].present?    config.anthropic_api_key = ENV[&#x22;ANTHROPIC_API_KEY&#x22;] if ENV[&#x22;ANTHROPIC_API_KEY&#x22;].present?    config.openai_api_key = ENV[&#x22;OPENAI_API_KEY&#x22;] if ENV[&#x22;OPENAI_API_KEY&#x22;].present?  end  model = ENV.fetch(&#x22;DSPY_MODEL&#x22;, &#x22;ruby_llm/gemini-2.5-flash&#x22;)  DSPy.configure do |config|    config.lm = DSPy::LM.new(model, structured_outputs: true)    config.logger = Rails.logger  end  # Langfuse observability (optional)  if ENV[&#x22;LANGFUSE_PUBLIC_KEY&#x22;].present? &#x26;&#x26; ENV[&#x22;LANGFUSE_SECRET_KEY&#x22;].present?    DSPy::Observability.configure!  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="feature-flagged-model-selection">Feature-Flagged Model Selection</h3><a class="sl-anchor-link" href="#feature-flagged-model-selection"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Feature-Flagged Model Selection”</span></a></div>
<p>Use different models for different roles (fast/cheap for classification, powerful for synthesis):</p>
<div class="expressive-code"><figure class="frame has-title not-content"><figcaption class="header"><span class="title">config/initializers/feature_flags.rb</span></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">module</span><span style="--0:#D6DEEB;--1:#403F53"> FeatureFlags</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">SELECTOR_MODEL</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">fetch</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">DSPY_SELECTOR_MODEL</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">ruby_llm/gemini-2.5-flash-lite</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">SYNTHESIZER_MODEL</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">fetch</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">DSPY_SYNTHESIZER_MODEL</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">ruby_llm/gemini-2.5-flash</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="module FeatureFlags  SELECTOR_MODEL = ENV.fetch(&#x22;DSPY_SELECTOR_MODEL&#x22;, &#x22;ruby_llm/gemini-2.5-flash-lite&#x22;)  SYNTHESIZER_MODEL = ENV.fetch(&#x22;DSPY_SYNTHESIZER_MODEL&#x22;, &#x22;ruby_llm/gemini-2.5-flash&#x22;)end"><div></div></button></div></figure></div>
<p>Then override per-tool or per-predictor:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">ClassifyTool</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Tools::Base</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#82AAFF;--1:#3B61B0">query:</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">predictor</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Predict</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">ClassifyQuery</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">predictor.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> { |</span><span style="--0:#C5E478;--1:#3B61B0">c</span><span style="--0:#D6DEEB;--1:#403F53">| c.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">LM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">FeatureFlags</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">SELECTOR_MODEL</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">structured_outputs</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53">) }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">predictor.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">query</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> query)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class ClassifyTool < DSPy::Tools::Base  def call(query:)    predictor = DSPy::Predict.new(ClassifyQuery)    predictor.configure { |c| c.lm = DSPy::LM.new(FeatureFlags::SELECTOR_MODEL, structured_outputs: true) }    predictor.call(query: query)  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="schema-driven-signatures">Schema-Driven Signatures</h2><a class="sl-anchor-link" href="#schema-driven-signatures"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Schema-Driven Signatures”</span></a></div>
<p><strong>Prefer typed schemas over string descriptions.</strong> Let the type system communicate structure to the LLM rather than prose in the signature description.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="entities-as-shared-types">Entities as Shared Types</h3><a class="sl-anchor-link" href="#entities-as-shared-types"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Entities as Shared Types”</span></a></div>
<p>Define reusable <code dir="auto">T::Struct</code> and <code dir="auto">T::Enum</code> types in <code dir="auto">app/entities/</code> and reference them across signatures:</p>
<div class="expressive-code"><figure class="frame has-title not-content"><figcaption class="header"><span class="title">app/entities/search_strategy.rb</span></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">SearchStrategy</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Enum</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">enums </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">SingleSearch</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">single_search</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">DateDecomposition</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">date_decomposition</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># app/entities/scored_item.rb</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">ScoredItem</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Struct</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">id</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">score</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Float</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Relevance score 0.0-1.0</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">verdict</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">relevant, maybe, or irrelevant</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">reason</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">""</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class SearchStrategy < T::Enum  enums do    SingleSearch = new(&#x22;single_search&#x22;)    DateDecomposition = new(&#x22;date_decomposition&#x22;)  endend# app/entities/scored_item.rbclass ScoredItem < T::Struct  const :id, String  const :score, Float, description: &#x22;Relevance score 0.0-1.0&#x22;  const :verdict, String, description: &#x22;relevant, maybe, or irrelevant&#x22;  const :reason, String, default: &#x22;&#x22;end"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="schema-vs-description-when-to-use-each">Schema vs Description: When to Use Each</h3><a class="sl-anchor-link" href="#schema-vs-description-when-to-use-each"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Schema vs Description: When to Use Each”</span></a></div>
<p><strong>Use schemas (T::Struct/T::Enum)</strong> for:</p>
<ul>
<li>Multi-field outputs with specific types</li>
<li>Enums with defined values the LLM must pick from</li>
<li>Nested structures, arrays of typed objects</li>
<li>Outputs consumed by code (not displayed to users)</li>
</ul>
<p><strong>Use string descriptions</strong> for:</p>
<ul>
<li>Simple single-field outputs where the type is <code dir="auto">String</code></li>
<li>Natural language generation (summaries, answers)</li>
<li>Fields where constraint guidance helps (e.g., <code dir="auto">description: "YYYY-MM-DD format"</code>)</li>
</ul>
<p><strong>Rule of thumb</strong>: If you’d write a <code dir="auto">case</code> statement on the output, it should be a <code dir="auto">T::Enum</code>. If you’d call <code dir="auto">.each</code> on it, it should be <code dir="auto">T::Array[SomeStruct]</code>.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="tool-patterns">Tool Patterns</h2><a class="sl-anchor-link" href="#tool-patterns"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Tool Patterns”</span></a></div>
<div class="sl-heading-wrapper level-h3"><h3 id="tools-that-wrap-predictions">Tools That Wrap Predictions</h3><a class="sl-anchor-link" href="#tools-that-wrap-predictions"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Tools That Wrap Predictions”</span></a></div>
<p>A common pattern: tools encapsulate a DSPy prediction, adding error handling, model selection, and serialization:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">RerankTool</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Tools::Base</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">tool_name </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">rerank</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">tool_description </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Score and rank search results by relevance</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">MAX_ITEMS</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">200</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">MIN_ITEMS_FOR_LLM</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">5</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">sig { </span><span style="--0:#82AAFF;--1:#3B61B0">params(</span><span style="--0:#7FDBCA;--1:#096E72">query</span><span style="--0:#82AAFF;--1:#3B61B0">: String, </span><span style="--0:#7FDBCA;--1:#096E72">items</span><span style="--1:#3B61B0"><span style="--0:#82AAFF">: </span><span style="--0:#C5E478">T</span><span style="--0:#82AAFF">::</span><span style="--0:#C5E478">Array</span></span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--1:#3B61B0"><span style="--0:#C5E478">T</span><span style="--0:#82AAFF">::</span><span style="--0:#C5E478">Hash</span></span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--1:#3B61B0"><span style="--0:#82AAFF">Symbol, </span><span style="--0:#C5E478">T</span><span style="--0:#82AAFF">.untyped</span></span><span style="--0:#D6DEEB;--1:#403F53">]]</span><span style="--0:#82AAFF;--1:#3B61B0">)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">returns</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Hash</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">Symbol</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">untyped</span><span style="--0:#D6DEEB;--1:#403F53">]) }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#82AAFF;--1:#3B61B0">query:</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">items:</span><span style="--0:#D6DEEB;--1:#403F53"> []</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">return</span><span style="--0:#D6DEEB;--1:#403F53"> { </span><span style="--0:#7FDBCA;--1:#096E72">scored_items</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> items, </span><span style="--0:#7FDBCA;--1:#096E72">reranked</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">false</span><span style="--0:#D6DEEB;--1:#403F53"> } </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> items.</span><span style="--0:#82AAFF;--1:#3B61B0">size</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">&#x3C;</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">MIN_ITEMS_FOR_LLM</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">capped_items</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> items.</span><span style="--0:#82AAFF;--1:#3B61B0">first</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">MAX_ITEMS</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">predictor</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Predict</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#82AAFF;--1:#3B61B0">RerankSignature</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">predictor.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> { |</span><span style="--0:#C5E478;--1:#3B61B0">c</span><span style="--0:#D6DEEB;--1:#403F53">| c.</span><span style="--0:#82AAFF;--1:#3B61B0">lm</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">LM</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3B61B0">FeatureFlags</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">SYNTHESIZER_MODEL</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">structured_outputs</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53">) }</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> predictor.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">query</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> query, </span><span style="--0:#7FDBCA;--1:#096E72">items</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> capped_items)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">{ </span><span style="--0:#7FDBCA;--1:#096E72">scored_items</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> result.</span><span style="--0:#82AAFF;--1:#3B61B0">scored_items</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">reranked</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">true</span><span style="--0:#D6DEEB;--1:#403F53"> }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">rescue</span><span style="--0:#D6DEEB;--1:#403F53"> => e</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">logger</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#C5E478;--1:#3B61B0">warn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">[RerankTool] LLM rerank failed: </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">e.</span><span style="--0:#82AAFF;--1:#3B61B0">message</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">{ </span><span style="--0:#7FDBCA;--1:#096E72">error</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Rerank failed: </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">e.</span><span style="--0:#82AAFF;--1:#3B61B0">message</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">scored_items</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> items, </span><span style="--0:#7FDBCA;--1:#096E72">reranked</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#FF6A83;--1:#A24848">false</span><span style="--0:#D6DEEB;--1:#403F53"> }</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class RerankTool < DSPy::Tools::Base  tool_name &#x22;rerank&#x22;  tool_description &#x22;Score and rank search results by relevance&#x22;  MAX_ITEMS = 200  MIN_ITEMS_FOR_LLM = 5  sig { params(query: String, items: T::Array[T::Hash[Symbol, T.untyped]]).returns(T::Hash[Symbol, T.untyped]) }  def call(query:, items: [])    return { scored_items: items, reranked: false } if items.size < MIN_ITEMS_FOR_LLM    capped_items = items.first(MAX_ITEMS)    predictor = DSPy::Predict.new(RerankSignature)    predictor.configure { |c| c.lm = DSPy::LM.new(FeatureFlags::SYNTHESIZER_MODEL, structured_outputs: true) }    result = predictor.call(query: query, items: capped_items)    { scored_items: result.scored_items, reranked: true }  rescue => e    Rails.logger.warn &#x22;[RerankTool] LLM rerank failed: #{e.message}&#x22;    { error: &#x22;Rerank failed: #{e.message}&#x22;, scored_items: items, reranked: false }  endend"><div></div></button></div></figure></div>
<p><strong>Key patterns:</strong></p>
<ul>
<li>Short-circuit LLM calls when unnecessary (small data, trivial cases)</li>
<li>Cap input size to prevent token overflow</li>
<li>Per-tool model selection via <code dir="auto">configure</code></li>
<li>Graceful error handling with fallback data</li>
</ul>
<div class="sl-heading-wrapper level-h3"><h3 id="error-handling-concern">Error Handling Concern</h3><a class="sl-anchor-link" href="#error-handling-concern"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Error Handling Concern”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">module</span><span style="--0:#D6DEEB;--1:#403F53"> ErrorHandling</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">extend</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">ActiveSupport</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Concern</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">private</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">def</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">safe_predict</span><span style="--0:#D9F5DD;--1:#111111">(</span><span style="--0:#7FDBCA;--1:#096E72">signature_class</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C792EA;--1:#8844AE">**</span><span style="--0:#7FDBCA;--1:#096E72">inputs</span><span style="--0:#D9F5DD;--1:#111111">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">predictor</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Predict</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53">(signature_class)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C792EA;--1:#8844AE">yield</span><span style="--0:#D6DEEB;--1:#403F53"> predictor </span><span style="--0:#C792EA;--1:#8844AE">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">block_given?</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">predictor.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8844AE">**</span><span style="--0:#D6DEEB;--1:#403F53">inputs)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">rescue</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">Faraday</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">Error</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">Net</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">HTTPError</span><span style="--0:#D6DEEB;--1:#403F53"> => e</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">logger</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">error</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">[</span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#7FDBCA;--1:#096E72">self</span><span style="--0:#ECC48D;--1:#984E4D">.</span><span style="--0:#82AAFF;--1:#3B61B0">class</span><span style="--0:#ECC48D;--1:#984E4D">.</span><span style="--0:#82AAFF;--1:#3B61B0">name</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#ECC48D;--1:#984E4D">] API error: </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">e.</span><span style="--0:#82AAFF;--1:#3B61B0">message</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">nil</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">rescue</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">JSON</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#82AAFF;--1:#3B61B0">ParserError</span><span style="--0:#D6DEEB;--1:#403F53"> => e</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">Rails</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">logger</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">error</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">[</span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#7FDBCA;--1:#096E72">self</span><span style="--0:#ECC48D;--1:#984E4D">.</span><span style="--0:#82AAFF;--1:#3B61B0">class</span><span style="--0:#ECC48D;--1:#984E4D">.</span><span style="--0:#82AAFF;--1:#3B61B0">name</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#ECC48D;--1:#984E4D">] Invalid LLM output: </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">e.</span><span style="--0:#82AAFF;--1:#3B61B0">message</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">nil</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="module ErrorHandling  extend ActiveSupport::Concern  private  def safe_predict(signature_class, **inputs)    predictor = DSPy::Predict.new(signature_class)    yield predictor if block_given?    predictor.call(**inputs)  rescue Faraday::Error, Net::HTTPError => e    Rails.logger.error &#x22;[#{self.class.name}] API error: #{e.message}&#x22;    nil  rescue JSON::ParserError => e    Rails.logger.error &#x22;[#{self.class.name}] Invalid LLM output: #{e.message}&#x22;    nil  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="observability">Observability</h2><a class="sl-anchor-link" href="#observability"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Observability”</span></a></div>
<div class="sl-heading-wrapper level-h3"><h3 id="tracing-with-dspycontext">Tracing with DSPy::Context</h3><a class="sl-anchor-link" href="#tracing-with-dspycontext"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Tracing with DSPy::Context”</span></a></div>
<p>Wrap operations in spans for Langfuse/OpenTelemetry visibility:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Context</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">with_span</span><span style="--0:#D6DEEB;--1:#403F53">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">operation</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">tool_selector.select</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">dspy.module</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> => </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">ToolSelector</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">,</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">tool_selector.tools</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> => tool_names.</span><span style="--0:#82AAFF;--1:#3B61B0">join</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">,</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#7FDBCA;--1:#096E72">@predictor</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">query</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> query, </span><span style="--0:#7FDBCA;--1:#096E72">context</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> context, </span><span style="--0:#7FDBCA;--1:#096E72">available_tools</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> schemas)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="result = DSPy::Context.with_span(  operation: &#x22;tool_selector.select&#x22;,  &#x22;dspy.module&#x22; => &#x22;ToolSelector&#x22;,  &#x22;tool_selector.tools&#x22; => tool_names.join(&#x22;,&#x22;)) do  @predictor.call(query: query, context: context, available_tools: schemas)end"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="setup-for-langfuse">Setup for Langfuse</h3><a class="sl-anchor-link" href="#setup-for-langfuse"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Setup for Langfuse”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Gemfile</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-o11y</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span style="--0:#D6DEEB;--1:#403F53">gem </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">dspy-o11y-langfuse</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># .env</span></div></div><div class="ec-line"><div class="code"><span style="--0:#82AAFF;--1:#3B61B0">LANGFUSE_PUBLIC_KEY</span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53">pk</span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53">...</span></div></div><div class="ec-line"><div class="code"><span style="--0:#82AAFF;--1:#3B61B0">LANGFUSE_SECRET_KEY</span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53">sk</span><span style="--0:#C792EA;--1:#8844AE">-</span><span style="--0:#D6DEEB;--1:#403F53">...</span></div></div><div class="ec-line"><div class="code"><span style="--0:#82AAFF;--1:#3B61B0">DSPY_TELEMETRY_BATCH_SIZE</span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#F78C6C;--1:#AA0982">5</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Gemfilegem &#x27;dspy-o11y&#x27;gem &#x27;dspy-o11y-langfuse&#x27;# .envLANGFUSE_PUBLIC_KEY=pk-...LANGFUSE_SECRET_KEY=sk-...DSPY_TELEMETRY_BATCH_SIZE=5"><div></div></button></div></figure></div>
<p>Every <code dir="auto">DSPy::Predict</code>, <code dir="auto">DSPy::ReAct</code>, and tool call is automatically traced when observability is configured.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="score-reporting">Score Reporting</h3><a class="sl-anchor-link" href="#score-reporting"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Score Reporting”</span></a></div>
<p>Report evaluation scores to Langfuse:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">DSPy</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">score</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">name</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">relevance</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">value</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0.85</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">trace_id</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> current_trace_id)</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="DSPy.score(name: &#x22;relevance&#x22;, value: 0.85, trace_id: current_trace_id)"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="testing">Testing</h2><a class="sl-anchor-link" href="#testing"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Testing”</span></a></div>
<div class="sl-heading-wrapper level-h3"><h3 id="vcr-setup-for-rails">VCR Setup for Rails</h3><a class="sl-anchor-link" href="#vcr-setup-for-rails"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “VCR Setup for Rails”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">VCR</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">configure</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span><span style="--0:#D6DEEB;--1:#403F53"> |</span><span style="--0:#C5E478;--1:#3B61B0">config</span><span style="--0:#D6DEEB;--1:#403F53">|</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">cassette_library_dir</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">spec/vcr_cassettes</span><span style="--0:#D9F5DD;--1:#111111">"</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">hook_into</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">webmock</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">configure_rspec_metadata!</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">filter_sensitive_data</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">&#x3C;GEMINI_API_KEY></span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">) { </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">GEMINI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">] }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">config.</span><span style="--0:#82AAFF;--1:#3B61B0">filter_sensitive_data</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">&#x3C;OPENAI_API_KEY></span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">) { </span><span style="--0:#82AAFF;--1:#3B61B0">ENV</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">OPENAI_API_KEY</span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#D6DEEB;--1:#403F53">] }</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="VCR.configure do |config|  config.cassette_library_dir = &#x22;spec/vcr_cassettes&#x22;  config.hook_into :webmock  config.configure_rspec_metadata!  config.filter_sensitive_data(&#x27;<GEMINI_API_KEY>&#x27;) { ENV[&#x27;GEMINI_API_KEY&#x27;] }  config.filter_sensitive_data(&#x27;<OPENAI_API_KEY>&#x27;) { ENV[&#x27;OPENAI_API_KEY&#x27;] }end"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="signature-schema-tests">Signature Schema Tests</h3><a class="sl-anchor-link" href="#signature-schema-tests"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Signature Schema Tests”</span></a></div>
<p>Test that signatures produce valid schemas without calling any LLM:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">RSpec</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">describe</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">ClassifyResearchQuery</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">it </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">has required input fields</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">schema</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> described_class.</span><span style="--0:#82AAFF;--1:#3B61B0">input_json_schema</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">expect(schema</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">required</span><span style="--0:#D6DEEB;--1:#403F53">]</span><span style="--0:#82AAFF;--1:#3B61B0">)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">to</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#096E72">include</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">query</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">it </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">has typed output fields</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">schema</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> described_class.</span><span style="--0:#82AAFF;--1:#3B61B0">output_json_schema</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">expect(schema</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">properties</span><span style="--0:#D6DEEB;--1:#403F53">]</span><span style="--0:#82AAFF;--1:#3B61B0">)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">to</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">have_key(:</span><span style="--0:#82AAFF;--1:#096E72">search_strategy</span><span style="--0:#82AAFF;--1:#3B61B0">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="RSpec.describe ClassifyResearchQuery do  it &#x22;has required input fields&#x22; do    schema = described_class.input_json_schema    expect(schema[:required]).to include(&#x22;query&#x22;)  end  it &#x22;has typed output fields&#x22; do    schema = described_class.output_json_schema    expect(schema[:properties]).to have_key(:search_strategy)  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="tool-tests-with-mocked-predictions">Tool Tests with Mocked Predictions</h3><a class="sl-anchor-link" href="#tool-tests-with-mocked-predictions"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Tool Tests with Mocked Predictions”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C5E478;--1:#3B61B0">RSpec</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">describe</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">RerankTool</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#82AAFF;--1:#3B61B0">let(:</span><span style="--0:#82AAFF;--1:#096E72">tool</span><span style="--0:#82AAFF;--1:#3B61B0">)</span><span style="--0:#D6DEEB;--1:#403F53"> { described_class.</span><span style="--0:#7FDBCA;--1:#096E72">new</span><span style="--0:#D6DEEB;--1:#403F53"> }</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">it </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">skips LLM for small result sets</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--1:#3B61B0"><span style="--0:#82AAFF">expect(</span><span style="--0:#C5E478">DSPy</span><span style="--0:#82AAFF">::Predict)</span></span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">not_to</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3B61B0">receive(:</span><span style="--0:#82AAFF;--1:#096E72">new</span><span style="--0:#82AAFF;--1:#3B61B0">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> tool.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">query</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">test</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">items</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> [{ </span><span style="--0:#7FDBCA;--1:#096E72">id</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">1</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> }])</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">expect(result</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">reranked</span><span style="--0:#D6DEEB;--1:#403F53">]</span><span style="--0:#82AAFF;--1:#3B61B0">)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">to</span><span style="--0:#D6DEEB;--1:#403F53"> be </span><span style="--0:#FF6A83;--1:#A24848">false</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">it </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">calls LLM for large result sets</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">vcr</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">items</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">10</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">times</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">map</span><span style="--0:#D6DEEB;--1:#403F53"> { |</span><span style="--0:#C5E478;--1:#3B61B0">i</span><span style="--0:#D6DEEB;--1:#403F53">| { </span><span style="--0:#7FDBCA;--1:#096E72">id</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> i.</span><span style="--0:#82AAFF;--1:#3B61B0">to_s</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">title</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">Item </span><span style="--0:#E2817F;--1:#B23834">#{</span><span style="--0:#ECC48D;--1:#984E4D">i</span><span style="--0:#E2817F;--1:#B23834">}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53"> } }</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#C5E478;--1:#3B61B0">result</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8844AE">=</span><span style="--0:#D6DEEB;--1:#403F53"> tool.</span><span style="--0:#82AAFF;--1:#3B61B0">call</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#096E72">query</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#984E4D">relevant items</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">items</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> items)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#82AAFF;--1:#3B61B0">expect(result</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">reranked</span><span style="--0:#D6DEEB;--1:#403F53">]</span><span style="--0:#82AAFF;--1:#3B61B0">)</span><span style="--0:#D6DEEB;--1:#403F53">.</span><span style="--0:#82AAFF;--1:#3B61B0">to</span><span style="--0:#D6DEEB;--1:#403F53"> be </span><span style="--0:#FF6A83;--1:#A24848">true</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="RSpec.describe RerankTool do  let(:tool) { described_class.new }  it &#x22;skips LLM for small result sets&#x22; do    expect(DSPy::Predict).not_to receive(:new)    result = tool.call(query: &#x22;test&#x22;, items: [{ id: &#x22;1&#x22; }])    expect(result[:reranked]).to be false  end  it &#x22;calls LLM for large result sets&#x22;, :vcr do    items = 10.times.map { |i| { id: i.to_s, title: &#x22;Item #{i}&#x22; } }    result = tool.call(query: &#x22;relevant items&#x22;, items: items)    expect(result[:reranked]).to be true  endend"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h2"><h2 id="resources">Resources</h2><a class="sl-anchor-link" href="#resources"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Resources”</span></a></div>
<ul>
<li><a href="./references/core-concepts.md">core-concepts.md</a> — Signatures, modules, predictors, type system deep-dive</li>
<li><a href="./references/toolsets.md">toolsets.md</a> — Tools::Base, Tools::Toolset DSL, type safety, testing</li>
<li><a href="./references/providers.md">providers.md</a> — Provider adapters, RubyLLM, fiber-local LM context, compatibility matrix</li>
<li><a href="./references/optimization.md">optimization.md</a> — MIPROv2, GEPA, evaluation framework, storage system</li>
<li><a href="./references/observability.md">observability.md</a> — Event system, dspy-o11y gems, Langfuse, score reporting</li>
<li><a href="./assets/signature-template.rb">signature-template.rb</a> — Signature scaffold with T::Enum, Date/Time, defaults, union types</li>
<li><a href="./assets/module-template.rb">module-template.rb</a> — Module scaffold with .call(), lifecycle callbacks, fiber-local LM</li>
<li><a href="./assets/config-template.rb">config-template.rb</a> — Rails initializer with RubyLLM, observability, feature flags</li>
</ul>
<div class="sl-heading-wrapper level-h2"><h2 id="key-urls">Key URLs</h2><a class="sl-anchor-link" href="#key-urls"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Key URLs”</span></a></div>
<ul>
<li>Homepage: <a href="https://oss.vicente.services/dspy.rb/">https://oss.vicente.services/dspy.rb/</a></li>
<li>GitHub: <a href="https://github.com/vicentereig/dspy.rb">https://github.com/vicentereig/dspy.rb</a></li>
<li>Documentation: <a href="https://oss.vicente.services/dspy.rb/getting-started/">https://oss.vicente.services/dspy.rb/getting-started/</a></li>
</ul>
<div class="sl-heading-wrapper level-h2"><h2 id="guidelines-for-claude">Guidelines for Claude</h2><a class="sl-anchor-link" href="#guidelines-for-claude"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Guidelines for Claude”</span></a></div>
<p>When helping users with DSPy.rb:</p>
<ol>
<li><strong>Schema over prose</strong> — Define output structure with <code dir="auto">T::Struct</code> and <code dir="auto">T::Enum</code> types, not string descriptions</li>
<li><strong>Entities in <code dir="auto">app/entities/</code></strong> — Extract shared types so signatures stay thin</li>
<li><strong>Per-tool model selection</strong> — Use <code dir="auto">predictor.configure { |c| c.lm = ... }</code> to pick the right model per task</li>
<li><strong>Short-circuit LLM calls</strong> — Skip the LLM for trivial cases (small data, cached results)</li>
<li><strong>Cap input sizes</strong> — Prevent token overflow by limiting array sizes before sending to LLM</li>
<li><strong>Test schemas without LLM</strong> — Validate <code dir="auto">input_json_schema</code> and <code dir="auto">output_json_schema</code> in unit tests</li>
<li><strong>VCR for integration tests</strong> — Record real HTTP interactions, never mock LLM responses by hand</li>
<li><strong>Trace with spans</strong> — Wrap tool calls in <code dir="auto">DSPy::Context.with_span</code> for observability</li>
<li><strong>Graceful degradation</strong> — Always rescue LLM errors and return fallback data</li>
</ol>
<div class="sl-heading-wrapper level-h3"><h3 id="signature-best-practices">Signature Best Practices</h3><a class="sl-anchor-link" href="#signature-best-practices"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Signature Best Practices”</span></a></div>
<p><strong>Keep description concise</strong> — The signature <code dir="auto">description</code> should state the goal, not the field details:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Good — concise goal</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">ParseOutline</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">DSPy::Signature</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">description </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">Extract block-level structure from HTML as a flat list of skeleton sections.</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">input </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">html</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">Raw HTML to parse</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">output </span><span style="--0:#C792EA;--1:#8844AE">do</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">    </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">sections</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Array</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">Section</span><span style="--0:#D6DEEB;--1:#403F53">], </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">Block elements: headings, paragraphs, code blocks, lists</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#C792EA;--1:#8844AE">end</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Good — concise goalclass ParseOutline < DSPy::Signature  description &#x27;Extract block-level structure from HTML as a flat list of skeleton sections.&#x27;  input do    const :html, String, description: &#x27;Raw HTML to parse&#x27;  end  output do    const :sections, T::Array[Section], description: &#x27;Block elements: headings, paragraphs, code blocks, lists&#x27;  endend"><div></div></button></div></figure></div>
<p><strong>Use defaults over nilable arrays</strong> — For OpenAI structured outputs compatibility:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#919F9F;--1:#5F636F"># Good — works with OpenAI structured outputs</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">ASTNode</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Struct</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">children</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Array</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">ASTNode</span><span style="--0:#D6DEEB;--1:#403F53">], </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> []</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# Good — works with OpenAI structured outputsclass ASTNode < T::Struct  const :children, T::Array[ASTNode], default: []end"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="recursive-types-with-defs">Recursive Types with <code dir="auto">$defs</code></h3><a class="sl-anchor-link" href="#recursive-types-with-defs"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Recursive Types with $defs”</span></a></div>
<p>DSPy.rb supports recursive types in structured outputs using JSON Schema <code dir="auto">$defs</code>:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">TreeNode</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Struct</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">value</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">children</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Array</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">TreeNode</span><span style="--0:#D6DEEB;--1:#403F53">], </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> []  </span><span style="--0:#919F9F;--1:#5F636F"># Self-reference</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class TreeNode < T::Struct  const :value, String  const :children, T::Array[TreeNode], default: []  # Self-referenceend"><div></div></button></div></figure></div>
<p>The schema generator automatically creates <code dir="auto">#/$defs/TreeNode</code> references for recursive types, compatible with OpenAI and Gemini structured outputs.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="field-descriptions-for-tstruct">Field Descriptions for T::Struct</h3><a class="sl-anchor-link" href="#field-descriptions-for-tstruct"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Field Descriptions for T::Struct”</span></a></div>
<p>DSPy.rb extends T::Struct to support field-level <code dir="auto">description:</code> kwargs that flow to JSON Schema:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="ruby"><code><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">class</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#ECC48D;--1:#984E4D">ASTNode</span><span style="--0:#D6DEEB;--1:#403F53"> &#x3C; </span><span style="--0:#C5E478;--1:#3B61B0">T::Struct</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">node_type</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">NodeType</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">The type of node (heading, paragraph, etc.)</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">text</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">String</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">""</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">description</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">'</span><span style="--0:#ECC48D;--1:#984E4D">Text content of the node</span><span style="--0:#D9F5DD;--1:#111111">'</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">level</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#82AAFF;--1:#3B61B0">Integer</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">0</span><span style="--0:#D6DEEB;--1:#403F53">  </span><span style="--0:#919F9F;--1:#5F636F"># No description — field is self-explanatory</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#D6DEEB;--1:#403F53">  </span></span><span style="--0:#D6DEEB;--1:#403F53">const </span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#82AAFF;--1:#096E72">children</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3B61B0">T</span><span style="--0:#D6DEEB;--1:#403F53">::</span><span style="--0:#C5E478;--1:#3B61B0">Array</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#82AAFF;--1:#3B61B0">ASTNode</span><span style="--0:#D6DEEB;--1:#403F53">], </span><span style="--0:#7FDBCA;--1:#096E72">default</span><span style="--0:#82AAFF;--1:#3B61B0">:</span><span style="--0:#D6DEEB;--1:#403F53"> []</span></div></div><div class="ec-line"><div class="code"><span style="--0:#C792EA;--1:#8844AE">end</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="class ASTNode < T::Struct  const :node_type, NodeType, description: &#x27;The type of node (heading, paragraph, etc.)&#x27;  const :text, String, default: &#x22;&#x22;, description: &#x27;Text content of the node&#x27;  const :level, Integer, default: 0  # No description — field is self-explanatory  const :children, T::Array[ASTNode], default: []end"><div></div></button></div></figure></div>
<p><strong>When to use field descriptions</strong>: complex field semantics, enum-like strings, constrained values, nested structs with ambiguous names. <strong>When to skip</strong>: self-explanatory fields like <code dir="auto">name</code>, <code dir="auto">id</code>, <code dir="auto">url</code>, or boolean flags.</p>
<div class="sl-heading-wrapper level-h2"><h2 id="version">Version</h2><a class="sl-anchor-link" href="#version"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only" data-pagefind-ignore="">Section titled “Version”</span></a></div>
<p>Current: 0.34.3</p> </div> <footer class="sl-flex astro-6hs6m4fg"> <div class="meta sl-flex astro-6hs6m4fg">   </div> <div class="pagination-links print:hidden astro-xgqntnr4" dir="ltr"> <a href="/systematic/reference/skills/document-review/" rel="prev" class="astro-xgqntnr4"> <svg aria-hidden="true" class="astro-xgqntnr4 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg> <span class="astro-xgqntnr4"> Previous <br class="astro-xgqntnr4"> <span class="link-title astro-xgqntnr4">Document Review</span> </span> </a> <a href="/systematic/reference/skills/every-style-editor/" rel="next" class="astro-xgqntnr4"> <svg aria-hidden="true" class="astro-xgqntnr4 astro-alwspyvt" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17.92 11.62a1.001 1.001 0 0 0-.21-.33l-5-5a1.003 1.003 0 1 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1.002 1.002 0 0 0 .325 1.639 1 1 0 0 0 1.095-.219l5-5a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76Z"/></svg> <span class="astro-xgqntnr4"> Next <br class="astro-xgqntnr4"> <span class="link-title astro-xgqntnr4">Every Style Editor</span> </span> </a> </div>   </footer>  </div> </div>   </main> </div> </div>  </div> </div>  </body></html>